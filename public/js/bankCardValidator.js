// 银行卡号识别工具
const BankCardValidator = {
    // 银行卡BIN码数据库（前6位）
    bankList: [
        // 中国工商银行
        { name: '中国工商银行', code: 'ICBC', bins: ['621226', '621225', '621281', '621558', '621559', '621722', '621723', '622200', '622202', '622203', '622208', '621225', '621226', '621227', '621288', '621721', '621227', '621288', '621721', '621281', '621558', '621559', '621722', '621723', '622200', '622202', '622203', '622208', '621226', '621225', '621281', '621558', '621559'] },
        
        // 中国农业银行
        { name: '中国农业银行', code: 'ABC', bins: ['622841', '622824', '622826', '622848', '620059', '621282', '622845', '622849', '623018', '623206'] },
        
        // 中国银行
        { name: '中国银行', code: 'BOC', bins: ['621660', '621661', '621662', '621663', '621665', '621667', '621668', '621669', '621666', '456351', '601382', '621256', '621212', '621283', '620061', '621725', '621330', '621331', '621332', '621333', '621297', '621568', '621569', '621672'] },
        
        // 中国建设银行
        { name: '中国建设银行', code: 'CCB', bins: ['621700', '622280', '622700', '621598', '622966', '622988', '621284', '436742', '489592', '530970', '530990', '558360', '621284', '622200', '622966', '622988', '621598', '621700', '622280', '622700'] },
        
        // 交通银行
        { name: '交通银行', code: 'COMM', bins: ['622261', '621002', '622260', '622262', '621069', '621436', '621335'] },
        
        // 招商银行
        { name: '招商银行', code: 'CMB', bins: ['621286', '621483', '621485', '621486', '621299', '690755', '545620', '545621', '545947', '545948', '552534', '552587', '622580', '622588', '622598', '622609', '690755'] },
        
        // 中国邮政储蓄银行
        { name: '中国邮政储蓄银行', code: 'PSBC', bins: ['621096', '621098', '622150', '622151', '622181', '622188', '622199', '955100', '621095', '620062'] },
        
        // 中信银行
        { name: '中信银行', code: 'CITIC', bins: ['622690', '622691', '622692', '622696', '622698', '433670', '433680', '442729', '442730', '620082', '621771', '622969'] },
        
        // 光大银行
        { name: '中国光大银行', code: 'CEB', bins: ['622660', '622662', '622663', '622664', '622665', '622666', '622667', '622670', '622671', '622672', '622673', '622674', '622675', '622676', '622678'] },
        
        // 民生银行
        { name: '中国民生银行', code: 'CMBC', bins: ['622615', '622616', '622618', '622619', '622620', '622622', '622623', '415599', '421393', '421865', '427570', '427571', '472067', '472068', '622622'] },
        
        // 平安银行
        { name: '平安银行', code: 'PAB', bins: ['622535', '622538', '622536', '622539', '415752', '622526', '623058', '602907', '622298'] },
        
        // 浦发银行
        { name: '上海浦东发展银行', code: 'SPDB', bins: ['622516', '622517', '622518', '622521', '622522', '622523', '984301', '984303', '456418', '498451', '622177', '622277'] },
        
        // 兴业银行
        { name: '兴业银行', code: 'CIB', bins: ['622902', '622922', '622901', '438589', '451289', '451290', '527414', '622901', '622902', '622922'] },
        
        // 华夏银行
        { name: '华夏银行', code: 'HXB', bins: ['622630', '622631', '622632', '622633', '539867', '539868', '622637', '622638', '622639'] },
        
        // 广发银行
        { name: '广东发展银行', code: 'GDB', bins: ['622568', '622569', '622570', '621352', '625072', '625071', '625073', '625806'] },
        
        // 北京银行
        { name: '北京银行', code: 'BOB', bins: ['621030', '602969', '621420', '621468', '621269'] },
        
        // 上海银行
        { name: '上海银行', code: 'BOS', bins: ['622172', '622985', '622987', '402673', '622267'] }
    ],

    // 根据卡号识别银行
    identifyBank(cardNumber) {
        // 移除空格
        const cleanNumber = cardNumber.replace(/\s/g, '');
        
        // 至少需要6位才能识别
        if (cleanNumber.length < 6) {
            return null;
        }

        // 获取前6位BIN码
        const bin = cleanNumber.substring(0, 6);

        // 查找匹配的银行
        for (let bank of this.bankList) {
            if (bank.bins.includes(bin)) {
                return {
                    name: bank.name,
                    code: bank.code,
                    bin: bin
                };
            }
        }

        // 未识别，返回null
        return null;
    },

    // Luhn算法验证银行卡号
    validateCardNumber(cardNumber) {
        const cleanNumber = cardNumber.replace(/\s/g, '');
        
        // 银行卡号长度应该在13-19位之间
        if (cleanNumber.length < 13 || cleanNumber.length > 19) {
            return false;
        }

        // 必须全是数字
        if (!/^\d+$/.test(cleanNumber)) {
            return false;
        }

        // Luhn算法验证
        let sum = 0;
        let isEven = false;

        // 从右往左遍历
        for (let i = cleanNumber.length - 1; i >= 0; i--) {
            let digit = parseInt(cleanNumber.charAt(i), 10);

            if (isEven) {
                digit *= 2;
                if (digit > 9) {
                    digit -= 9;
                }
            }

            sum += digit;
            isEven = !isEven;
        }

        return (sum % 10) === 0;
    },

    // 格式化银行卡号（每4位加空格）
    formatCardNumber(cardNumber) {
        const cleanNumber = cardNumber.replace(/\s/g, '');
        if (cleanNumber.length > 0) {
            return cleanNumber.match(/.{1,4}/g).join(' ');
        }
        return '';
    }
};

// 导出全局函数供其他脚本使用
window.getBankInfo = function(cardNumber) {
    return BankCardValidator.identifyBank(cardNumber);
};

window.validateLuhn = function(cardNumber) {
    return BankCardValidator.validateCardNumber(cardNumber);
};

window.formatBankCard = function(cardNumber) {
    return BankCardValidator.formatCardNumber(cardNumber);
};
