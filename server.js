const express = require('express');
const cors = require('cors');
const bodyParser = require('body-parser');
const axios = require('axios');
const path = require('path');
const fs = require('fs');
const multer = require('multer');
require('dotenv').config();

// å¼•å…¥ OSS ä¸Šä¼ å·¥å…·
const { isOssConfigured, uploadToOss } = require('./utils/ossUploader');

// å·¥å…·å‡½æ•°ï¼šç”ŸæˆéšæœºIPåœ°å€
function generateRandomIP() {
  // ç”Ÿæˆéšæœºçš„å†…ç½‘IPæˆ–å…¬ç½‘IP
  // è¿™é‡Œä½¿ç”¨å¸¸è§çš„å†…ç½‘IPæ®µæˆ–éšæœºå…¬ç½‘IP
  const types = ['private', 'public'];
  const type = types[Math.floor(Math.random() * types.length)];

  if (type === 'private') {
    // ç”Ÿæˆå†…ç½‘IPï¼ˆ192.168.x.x æˆ– 10.x.x.xï¼‰
    const segments = [
      [192, 168, Math.floor(Math.random() * 255), Math.floor(Math.random() * 255)],
      [10, Math.floor(Math.random() * 255), Math.floor(Math.random() * 255), Math.floor(Math.random() * 255)]
    ];
    const selected = segments[Math.floor(Math.random() * segments.length)];
    return selected.join('.');
  } else {
    // ç”Ÿæˆå…¬ç½‘IPï¼ˆé¿å¼€ä¿ç•™åœ°å€æ®µï¼‰
    const first = Math.floor(Math.random() * 223) + 1;  // 1-223
    const second = Math.floor(Math.random() * 255);
    const third = Math.floor(Math.random() * 255);
    const fourth = Math.floor(Math.random() * 254) + 1; // 1-254
    return `${first}.${second}.${third}.${fourth}`;
  }
}

// å·¥å…·å‡½æ•°ï¼šç»Ÿä¸€æ‰“å°æ¥å£è¿”å›æ—¥å¿—
function logApiResponse(apiName, responseData) {
  console.log(`\n${'='.repeat(60)}`);
  console.log(`ğŸ“¤ [${apiName}] è¿”å›ç»™å‰ç«¯çš„æ•°æ®:`);
  console.log(`${'='.repeat(60)}`);
  console.log(JSON.stringify(responseData, null, 2));
  console.log(`${'='.repeat(60)}\n`);
}

const app = express();
const PORT = process.env.PORT || 3000;

// åˆ›å»ºä¸Šä¼ ç›®å½•ï¼ˆå¦‚æœä¸ä½¿ç”¨ OSSï¼Œä½œä¸ºå¤‡ç”¨ï¼‰
const uploadDir = path.join(__dirname, 'uploads');
if (!fs.existsSync(uploadDir)) {
  fs.mkdirSync(uploadDir, { recursive: true });
}

// é…ç½® multer ç”¨äºæ–‡ä»¶ä¸Šä¼ 
// å¦‚æœä½¿ç”¨ OSSï¼Œå°†æ–‡ä»¶å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå¦åˆ™å­˜å‚¨åˆ°ç£ç›˜
const useOss = isOssConfigured();
console.log(`[ä¸Šä¼ é…ç½®] ${useOss ? 'ä½¿ç”¨ OSS å­˜å‚¨' : 'ä½¿ç”¨æœ¬åœ°å­˜å‚¨'}`);

const storage = useOss
  ? multer.memoryStorage()  // OSS: ä½¿ç”¨å†…å­˜å­˜å‚¨
  : multer.diskStorage({    // æœ¬åœ°: ä½¿ç”¨ç£ç›˜å­˜å‚¨
      destination: function (req, file, cb) {
        cb(null, uploadDir);
      },
      filename: function (req, file, cb) {
        // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å: æ—¶é—´æˆ³-éšæœºæ•°-åŸå§‹æ–‡ä»¶å
        const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
        const ext = path.extname(file.originalname);
        cb(null, file.fieldname + '-' + uniqueSuffix + ext);
      }
    });

const upload = multer({
  storage: storage,
  limits: {
    fileSize: 10 * 1024 * 1024 // é™åˆ¶10MB
  },
  fileFilter: function (req, file, cb) {
    // åªå…è®¸å›¾ç‰‡æ ¼å¼
    if (file.mimetype.startsWith('image/')) {
      cb(null, true);
    } else {
      cb(new Error('åªå…è®¸ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶'));
    }
  }
});

// ä¸­é—´ä»¶é…ç½®
app.use(cors());
app.use(bodyParser.json({ limit: '50mb' })); // å¢åŠ é™åˆ¶ä»¥æ”¯æŒBase64å›¾ç‰‡
app.use(bodyParser.urlencoded({ extended: true, limit: '50mb' }));

// é™æ€æ–‡ä»¶æœåŠ¡ - æä¾›å‰ç«¯é¡µé¢
app.use(express.static(path.join(__dirname, 'public')));
// æä¾›ä¸Šä¼ æ–‡ä»¶çš„è®¿é—®
app.use('/uploads', express.static(uploadDir));

// é“¶è¡Œåˆ—è¡¨(ä»äº¤æ˜“æ‰€è·å–)
const BANK_LIST = ["ä¸­å›½å·¥å•†é“¶è¡Œ","ä¸­å›½å†œä¸šé“¶è¡Œ","ä¸­å›½é“¶è¡Œ","ä¸­å›½å»ºè®¾é“¶è¡Œ","äº¤é€šé“¶è¡Œ","ä¸­å›½é‚®æ”¿å‚¨è“„é“¶è¡Œ","åå¤é“¶è¡Œ","æ‹›å•†é“¶è¡Œ","ä¸­ä¿¡é“¶è¡Œ","ä¸­å›½å…‰å¤§é“¶è¡Œ","ä¸­å›½æ°‘ç”Ÿé“¶è¡Œ","å…´ä¸šé“¶è¡Œæ€»è¡Œ","å¹¿ä¸œå‘å±•é“¶è¡Œ","ä¸Šæµ·æµ¦ä¸œå‘å±•é“¶è¡Œ","å¹³å®‰é“¶è¡Œ","åŒ—äº¬é“¶è¡Œ","å®‰å¾½çœå†œæ‘ä¿¡ç”¨è”ç¤¾","éå±±é“¶è¡Œ","è’™å•†é“¶è¡Œ","åŒ—äº¬å†œæ‘å•†ä¸šé“¶è¡Œ","åŒ—äº¬é¡ºä¹‰é“¶åº§æ‘é•‡é“¶è¡Œ","æ¸¤æµ·é“¶è¡Œ","æ²§å·é“¶è¡Œ","é•¿å®‰é“¶è¡Œ","é•¿æ²™é“¶è¡Œ","æ‰¿å¾·é“¶è¡Œ","é‡åº†å†œæ‘å•†ä¸šé“¶è¡Œ","é‡åº†é»”æ±Ÿé“¶åº§æ‘é•‡é“¶è¡Œ","é‡åº†é“¶è¡Œ","é‡åº†æ¸åŒ—é“¶åº§æ‘é•‡é“¶è¡Œ","å¤§è¿é“¶è¡Œ","é•¿åŸåè¥¿é“¶è¡Œ","å¾·å·é“¶è¡Œ","ä¸œèå†œæ‘å•†ä¸šé“¶è¡Œ","ä¸œèé“¶è¡Œ","ä¸œè¥é“¶è¡Œ","é„‚å°”å¤šæ–¯é“¶è¡Œ","ä½›å±±é¡ºå¾·å†œæ‘å•†ä¸šé“¶è¡Œ","ç¦å»ºæµ·å³¡é“¶è¡Œ","ç¦å»ºçœå†œæ‘ä¿¡ç”¨ç¤¾è”åˆç¤¾","é˜œæ–°é“¶è¡Œ","å¯Œæ»‡é“¶è¡Œ","èµ£å·é“¶è¡Œ","å¹¿ä¸œåå…´é“¶è¡Œ","å¹¿ä¸œå—ç²¤é“¶è¡Œ","å¹¿è¥¿åŒ—éƒ¨æ¹¾é“¶è¡Œ","å¹¿è¥¿å£®æ—è‡ªæ²»åŒºå†œæ‘ä¿¡ç”¨ç¤¾è”åˆç¤¾","å¹¿å·å†œæ‘å•†ä¸šé“¶è¡Œ","å¹¿å·é“¶è¡Œ","è´µé˜³é“¶è¡Œ","æ¡‚æ—é“¶è¡Œ","å“ˆå°”æ»¨é“¶è¡Œ","æµ·å—çœå†œæ‘ä¿¡ç”¨ç¤¾è”åˆç¤¾","é‚¯éƒ¸é“¶è¡Œ","éŸ©äºšé“¶è¡Œï¼ˆä¸­å›½ï¼‰æœ‰é™å…¬å¸","æ±‰å£é“¶è¡Œ","æ­å·é“¶è¡Œ","æ²³åŒ—é“¶è¡Œ","æ’ä¸°é“¶è¡Œ","æ¹–åŒ—çœå†œæ‘ä¿¡ç”¨ç¤¾è”åˆç¤¾","æ¹–å·é“¶è¡Œ","è‘«èŠ¦å²›é“¶è¡Œ","å¾½å•†é“¶è¡Œ","å‰æ—é“¶è¡Œ","æµå®é“¶è¡Œ","æ±Ÿè‹é•¿æ±Ÿå•†ä¸šé“¶è¡Œ","æ±Ÿè‹å¸¸ç†Ÿå†œæ‘å•†ä¸šé“¶è¡Œ","æ±Ÿè‹é“¶è¡Œ","æ±Ÿè¥¿èµ£å·é“¶åº§æ‘é•‡é“¶è¡Œ","é”¦å·é“¶è¡Œ","æ™‹åŸé“¶è¡Œ","æ™‹å•†é“¶è¡Œ","æ˜†ä»‘é“¶è¡Œ","æ˜†å±±å†œæ‘å•†ä¸šé“¶è¡Œ","è±å•†é“¶è¡Œ","å…°å·é“¶è¡Œ","å»ŠåŠé“¶è¡Œ","ä¸´å•†é“¶è¡Œ","æŸ³å·é“¶è¡Œæ¸…ç®—ä¸­å¿ƒ","ç»µé˜³å¸‚å•†ä¸šé“¶è¡Œ","æ±Ÿè¥¿é“¶è¡Œ","å—äº¬é“¶è¡Œ","å†…è’™å¤é“¶è¡Œ","å®æ³¢é„å·å†œæ‘å•†ä¸šé“¶è¡Œ(é„å·é“¶è¡Œ)","å®å¤é»„æ²³å†œæ‘å•†ä¸šé“¶è¡Œ","å®å¤é“¶è¡Œ","æ”€æèŠ±å¸‚å•†ä¸šé“¶è¡Œ","é½é²é“¶è¡Œ","é½å•†é“¶è¡Œ","ä¼ä¸šé“¶è¡Œï¼ˆä¸­å›½ï¼‰æœ‰é™å…¬å¸","é’å²›é“¶è¡Œ","é’æµ·é“¶è¡Œè¥ä¸šéƒ¨","æ³‰å·é“¶è¡Œ(ä¸å¯¹å¤–è¥ä¸š)","æ—¥ç…§é“¶è¡Œ","ä¸Šæµ·å†œæ‘å•†ä¸šé“¶è¡Œ","ä¸Šé¥¶é“¶è¡Œ","ç»å…´é“¶è¡Œè¥ä¸šéƒ¨","æ·±åœ³ç¦ç”°é“¶åº§æ‘é•‡é“¶è¡Œ","æ·±åœ³å†œæ‘å•†ä¸šé“¶è¡Œ","è‹å·é“¶è¡Œ","å¤ªä»“å†œæ‘å•†ä¸šé“¶è¡Œ","æ³°å®‰é“¶è¡Œ","å¤©æ´¥é“¶è¡Œ","å¤–æ¢é“¶è¡Œï¼ˆä¸­å›½ï¼‰æœ‰é™å…¬å¸","å¨æµ·å¸‚å•†ä¸šé“¶è¡Œ","æ½åŠé“¶è¡Œ","æ¸©å·é“¶è¡Œ","ä¹Œé²æœ¨é½é“¶è¡Œ","è‹å·å†œæ‘å•†ä¸šé“¶è¡Œ","è¥¿å®‰é“¶è¡Œ","å¦é—¨é“¶è¡Œ","æ–°éŸ©é“¶è¡Œï¼ˆä¸­å›½ï¼‰æœ‰é™å…¬å¸","é‚¢å°é“¶è¡Œ","çƒŸå°é“¶è¡Œ","è¥å£é“¶è¡Œèµ„é‡‘","å‹åˆ©é“¶è¡Œ(ä¸­å›½)æœ‰é™å…¬å¸","äº‘å—çœå†œæ‘ä¿¡ç”¨ç¤¾è”åˆç¤¾","å¼ å®¶æ¸¯å†œæ‘å•†ä¸šé“¶è¡Œ","å¼ å®¶å£é“¶è¡Œ","æµ™æ±Ÿç¨ å·å•†ä¸šé“¶è¡Œ","æµ™æ±Ÿæ™¯å®é“¶åº§æ‘é•‡é“¶è¡Œ","æµ™æ±Ÿæ°‘æ³°å•†ä¸šé“¶è¡Œ","æµ™æ±Ÿä¸‰é—¨é“¶åº§æ‘é•‡é“¶è¡Œ","æµ™æ±Ÿå†œå•†é“¶è¡Œ","æµ™æ±Ÿæ³°éš†å•†ä¸šé“¶è¡Œ","æµ™å•†é“¶è¡Œ","éƒ‘å·é“¶è¡Œ","ç æµ·åæ¶¦é“¶è¡Œ","è‡ªè´¡å¸‚å•†ä¸šé“¶è¡Œ","é¾™æ±Ÿé“¶è¡Œ","æµ·å£è”åˆå†œæ‘å•†ä¸šé“¶è¡Œ","æ£åº„é“¶è¡Œ","æ±Ÿè‹çœå†œæ‘ä¿¡ç”¨ç¤¾è”åˆç¤¾","å®æ³¢é“¶è¡Œ","ä¹æ±Ÿé“¶è¡Œ","å°å·é“¶è¡Œ","ä¸œäºšé“¶è¡Œï¼ˆä¸­å›½ï¼‰æœ‰é™å…¬å¸","æ±Ÿè‹æ±Ÿé˜´å†œæ‘å•†ä¸šé“¶è¡Œ","å››å·å¤©åºœé“¶è¡Œ","æˆéƒ½é“¶è¡Œ","å¤©æ´¥å†œæ‘å•†ä¸šé“¶è¡Œ","æ¹–åŒ—é“¶è¡Œ","ä¸­åŸé“¶è¡Œ","å››å·çœå†œæ‘ä¿¡ç”¨ç¤¾è”åˆç¤¾","è¡¡æ°´é“¶è¡Œ","æ­¦æ±‰å†œæ‘å•†ä¸šé“¶è¡Œ","å®æ³¢é€šå•†é“¶è¡Œ","ä¸œè¥è±å•†æ‘é•‡é“¶è¡Œ","å¯Œé‚¦åä¸€é“¶è¡Œæœ‰é™å…¬å¸","æ™‹ä¸­é“¶è¡Œ","æ¹–å—é“¶è¡Œ","æ›²é–å¸‚å•†ä¸šé“¶è¡Œ","é™•è¥¿çœå†œæ‘ä¿¡ç”¨ç¤¾è”åˆç¤¾","ä¹Œæµ·é“¶è¡Œ","æ— é”¡å†œæ‘å•†ä¸šé“¶è¡Œ","è´µå·çœå†œæ‘ä¿¡ç”¨ç¤¾è”åˆç¤¾","äº‘å—çº¢å¡”é“¶è¡Œ","çŸ³æ²³å­å›½æ°‘æ‘é•‡é“¶è¡Œ","ä¸­å¾·ä½æˆ¿å‚¨è“„é“¶è¡Œ","å“ˆå¯†çº¢æ˜Ÿå›½æ°‘æ‘é•‡é“¶è¡Œ","æ–°ç–†ç»¿æ´²å›½æ°‘æ‘é•‡é“¶è¡Œ","ä¼ŠçŠå›½æ°‘æ‘é•‡é“¶è¡Œ","å¥å±¯å›½æ°‘æ‘é•‡é“¶è¡Œ","è´µå·é“¶è¡Œ","å¹¿è¥¿ä¸Šæ—å›½æ°‘æ‘é•‡é“¶è¡Œ","é˜²åŸæ¸¯é˜²åŸå›½æ°‘æ‘é•‡é“¶è¡Œ","é‚å®é“¶è¡Œ","å¹¿è¥¿é“¶æµ·å›½æ°‘æ‘é•‡é“¶è¡Œ","æ˜Œå‰å›½æ°‘æ‘é•‡é“¶è¡Œ","å®œå®¾å¸‚å•†ä¸šé“¶è¡Œ","åä¾¨æ°¸äº¨é“¶è¡Œï¼ˆä¸­å›½ï¼‰æœ‰é™å…¬å¸","åŒ—å±¯å›½æ°‘æ‘é•‡é“¶è¡Œ","äº”å®¶æ¸ å›½æ°‘æ‘é•‡é“¶è¡Œ","åšä¹å›½æ°‘æ‘é•‡é“¶è¡Œ","æ²³å—çœå†œæ‘ä¿¡ç”¨ç¤¾è”åˆç¤¾","è¥å£æ²¿æµ·é“¶è¡Œ","ä¹å±±å¸‚å•†ä¸šé“¶è¡Œ","æ³¸å·é“¶è¡Œ","é‡åº†å¯Œæ°‘é“¶è¡Œ","æœé˜³é“¶è¡Œ","å†…è’™å¤è‡ªæ²»åŒºå†œæ‘ä¿¡ç”¨ç¤¾è”åˆç¤¾","å”å±±é“¶è¡Œ","å››å·æ–°ç½‘é“¶è¡Œ","ä¹å¹³èå…´æ‘é•‡é“¶è¡Œ","æ–°å®‰èå…´æ‘é•‡é“¶è¡Œ","åƒå¸ˆèå…´æ‘é•‡é“¶è¡Œ","æ±Ÿè‹å¦‚ä¸œèå…´æ‘é•‡é“¶è¡Œ","é‡åº†å¸‚æ²™åªåèå…´æ‘é•‡é“¶è¡Œ","å®æ³¢å¸‚æµ·æ›™å›½æ°‘æ‘é•‡é“¶è¡Œ","åº“è½¦å›½æ°‘æ‘é•‡é“¶è¡Œ","æ–°ç–†æ±‡å’Œé“¶è¡Œï¼ˆæ¸…ç®—è¡Œï¼‰","æ±Ÿè‹æƒ å±±æ°‘æ³°æ‘é•‡é“¶è¡Œ","æ±Ÿè‹é‚—æ±Ÿæ°‘æ³°æ‘é•‡é“¶è¡Œ","æ¹–å—çœå†œæ‘ä¿¡ç”¨ç¤¾è”åˆç¤¾","ä¸­ä¿¡ç™¾ä¿¡é“¶è¡Œ","å®æ³¢ä¸œæµ·é“¶è¡Œ","è¥¿è—é“¶è¡Œ","æ·±åœ³å‰æµ·å¾®ä¼—é“¶è¡Œ","ä¸Šæµ·é“¶è¡Œ","æ±Ÿè¥¿çœå†œæ‘ä¿¡ç”¨ç¤¾è”åˆç¤¾","æˆéƒ½å†œå•†é“¶è¡Œ","é‡‘åé“¶è¡Œ","æµ™æ±Ÿç½‘å•†é“¶è¡Œ","æ¸©å·æ°‘å•†é“¶è¡Œ","æ¹–å—ä¸‰æ¹˜é“¶è¡Œ","ç”˜è‚ƒçœå†œæ‘åˆä½œé‡‘èç»“ç®—æœåŠ¡ä¸­å¿ƒ","é•¿æ²»é“¶è¡Œ","é˜³æ³‰å¸‚å•†ä¸šé“¶è¡Œ","è¾¾å·é“¶è¡Œ","å‰æ—äº¿è”é“¶è¡Œ","ç¦å»ºåé€šé“¶è¡Œ","æ¢…å·å®¢å•†é“¶è¡Œ","ç§¦çš‡å²›é“¶è¡Œ","å¤§è¿å†œæ‘å•†ä¸šé“¶è¡Œ","æ²³é—´èæƒ æ‘é•‡é“¶è¡Œ","è®·æ²³èå…´æ‘é•‡é“¶è¡Œ","å®å®‰èå…´æ‘é•‡é“¶è¡Œ","æˆéƒ½é’ç™½æ±Ÿèå…´æ‘é•‡é“¶è¡Œ","é˜†ä¸­èå…´æ‘é•‡é“¶è¡Œ","å¤©æ°´éº¦ç§¯èå…´æ‘é•‡é“¶è¡Œ","é‚›å´ƒå›½æ°‘æ‘é•‡é“¶è¡Œ","æ±Ÿè‹é‡‘æ¹–æ°‘æ³°æ‘é•‡é“¶è¡Œ","æ–°ç–†é“¶è¡Œ","æŠšé¡ºé“¶è¡Œæ¸…ç®—ä¸­å¿ƒ","éµä¹‰æ–°è’²é•¿å¾æ‘é•‡é“¶è¡Œ","å‡‰å±±å·å•†ä¸šé“¶è¡Œ","æ’ç”Ÿé“¶è¡Œ(ä¸­å›½)æœ‰é™å…¬å¸ä¸Šæµ·åˆ†è¡Œ","æ¸£æ‰“é“¶è¡Œï¼ˆä¸­å›½ï¼‰æœ‰é™å…¬å¸ä¸Šæµ·åˆ†è¡Œ","æ·±åœ³å—å±±å®ç”Ÿæ‘é•‡é“¶è¡Œ","ä¸Šæµ·é—µè¡Œä¸Šé“¶æ‘é•‡é“¶è¡Œ","å®‰å¾½æ–°å®‰é“¶è¡Œ","å—æ˜Œæ˜Œä¸œä¹é“¶æ‘é•‡é“¶è¡Œ","æ™¯å¾·é•‡æ˜Œæ±Ÿä¹é“¶æ‘é•‡é“¶è¡Œ","ç‘æ˜Œä¹é“¶æ‘é•‡é“¶è¡Œ","ä¿®æ°´ä¹é“¶æ‘é•‡é“¶è¡Œ","åºå±±ä¹é“¶è‰ºæœ¯æ‘é•‡é“¶è¡Œ","éƒ½æ˜Œä¹é“¶æ‘é•‡é“¶è¡Œ","æ¹–å£ä¹é“¶æ‘é•‡é“¶è¡Œ","å½­æ³½ä¹é“¶æ‘é•‡é“¶è¡Œ","åˆ†å®œä¹é“¶æ‘é•‡é“¶è¡Œ","è´µæºªä¹é“¶æ‘é•‡é“¶è¡Œ","å¥‰æ–°ä¹é“¶æ‘é•‡é“¶è¡Œ","é“œé¼“ä¹é“¶æ‘é•‡é“¶è¡Œ","äº•å†ˆå±±ä¹é“¶æ‘é•‡é“¶è¡Œ","èµ„æºªä¹é“¶æ‘é•‡é“¶è¡Œ","å—é˜³æ‘é•‡é“¶è¡Œ","æ²³åŒ—çœå†œæ‘ä¿¡ç”¨ç¤¾è”åˆç¤¾","å¹¿ä¸œçœå†œæ‘ä¿¡ç”¨ç¤¾è”åˆç¤¾","å¦é—¨å›½é™…é“¶è¡Œ","é‡åº†ä¸‰å³¡é“¶è¡Œ","èŠ±æ——é“¶è¡Œ(ä¸­å›½)æœ‰é™å…¬å¸","ä¸œå…´å›½æ°‘æ‘é•‡é“¶è¡Œ","çŸ³å˜´å±±é“¶è¡Œ","ä¸Šæµ·åç‘é“¶è¡Œ","åˆæµ¦å›½æ°‘æ‘é•‡é“¶è¡Œ","è¾½å®çœå†œæ‘ä¿¡ç”¨ç¤¾è”åˆç¤¾","å¹³æœå›½æ°‘æ‘é•‡é“¶è¡Œ","ç”˜è‚ƒé“¶è¡Œ","ä¿å®šé“¶è¡Œ","è±¡å±±å›½æ°‘æ‘é•‡é“¶è¡Œ","é‡åº†å½­æ°´æ°‘æ³°æ‘é•‡é“¶è¡Œ","æµ™æ±Ÿé¾™æ³‰æ°‘æ³°æ‘é•‡é“¶è¡Œ","åŒ—äº¬æ˜Œå¹³å‘å±•æ‘é•‡é“¶è¡Œ","æ¯•èŠ‚å‘å±•æ‘é•‡é“¶è¡Œ","å¤§è¿é‡‘å·è”ä¸°æ‘é•‡é“¶è¡Œ","å›ºé˜³è’™å•†æ‘é•‡é“¶è¡Œ","è«åŠ›è¾¾ç“¦è’™å•†æ‘é•‡é“¶è¡Œ","åŒ–å¾·è’™å•†æ‘é•‡é“¶è¡Œ","å—é€šå¦‚çš‹æ¶¦æ³½æ‘é•‡é“¶è¡Œ","æ‰¬å·ä»ªå¾ç‰ä¸°æ‘é•‡é“¶è¡Œ","ä¹å°é¾™å˜‰æ‘é•‡é“¶è¡Œ","æ¼¯æ²³éƒ¾åŸä¸­åŸæ‘é•‡é“¶è¡Œ","å®åŸè’™å•†æ‘é•‡é“¶è¡Œ","å®å¤è´ºå…°å›å•†æ‘é•‡é“¶è¡Œ","å¤©æ´¥æ´¥å—æ‘é•‡é“¶è¡Œ","ä¹Œå…°å¯Ÿå¸ƒå¸‚é›†å®è’™å•†æ‘é•‡é“¶è¡Œ","ä¹Œå®¡æ——è’™å•†æ‘é•‡é“¶è¡Œ","æ­¦å†ˆåŒ…å•†æ‘é•‡é“¶è¡Œ","è¥¿ä¹Œç ç©†æ²è’™å•†æƒ ä¸°æ‘é•‡é“¶è¡Œ","æ¯çƒ½å‘å±•æ‘é•‡é“¶è¡Œ","å››å·æ–°éƒ½å†œä¿¡æ‘é•‡é“¶è¡Œ","å…´å®‰ç›Ÿç§‘å°”æ²è’™å•†æ‘é•‡é“¶è¡Œ","å‡†æ ¼å°”æ——è’™å•†æ‘é•‡é“¶è¡Œ","å†…è’™å¤å’Œæ—æ ¼å°”è’™å•†æ‘é•‡é“¶è¡Œ","è¾¾å°”ç½•èŒ‚æ˜å®‰è”åˆæ——è’™å•†æ‘é•‡é“¶è¡Œ","èµ¤å³°å¸‚çº¢å±±ç‰é¾™æ‘é•‡é“¶è¡Œ","èµ¤å³°å¸‚å…ƒå®å±±ç‰é¾™æ‘é•‡é“¶è¡Œ","é„‚æ¸©å…‹è’™å•†æ‘é•‡é“¶è¡Œ","æµ™æ±Ÿæ¡ä¹¡æ°‘æ³°æ‘é•‡é“¶è¡Œ","é‡åº†å¸‚æ­¦éš†èå…´æ‘é•‡é“¶è¡Œ","é‡åº†å¸‚å¤§æ¸¡å£èå…´æ‘é•‡é“¶è¡Œ","è€’é˜³èå…´æ‘é•‡é“¶è¡Œ","æ´ªæ¹–èå…´æ‘é•‡é“¶è¡Œ","æ‹œæ³‰èå…´æ‘é•‡é“¶è¡Œ","åŒ—äº¬æ€€æŸ”èå…´æ‘é•‡é“¶è¡Œ","åº”åŸèå…´æ‘é•‡é“¶è¡Œ","æ ªæ´²å¿èå…´æ‘é•‡é“¶è¡Œ","å®‰ä¹‰èå…´æ‘é•‡é“¶è¡Œ","å·´å½¦èå…´æ‘é•‡é“¶è¡Œ","æ¡¦å·èå…´æ‘é•‡é“¶è¡Œ","ä¼šå®ä¼šå¸ˆæ‘é•‡é“¶è¡Œ","å…°å·çš‹å…°æ–°åæ‘é•‡é“¶è¡Œ","å…°å·ä¸ƒé‡Œæ²³æ–°åæ‘é•‡é“¶è¡Œ","åº†é˜³å¸‚è¥¿å³°ç‘ä¿¡æ‘é•‡é“¶è¡Œè¥ä¸šéƒ¨","æµ™æ±Ÿä¹æ¸…è”åˆæ‘é•‡é“¶è¡Œ","æµ™æ±ŸæŸ¯æ¡¥è”åˆæ‘é•‡é“¶è¡Œ","æµ™æ±Ÿè¯¸æš¨è”åˆæ‘é•‡é“¶è¡Œ","å…°å·æ°¸ç™»æ–°åæ‘é•‡é“¶è¡Œ","é›…å®‰å¸‚å•†ä¸šé“¶è¡Œ","æµ™æ±ŸåµŠå·ç‘ä¸°æ‘é•‡é“¶è¡Œ","æ·±åœ³å…‰æ˜æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","æµ™æ±Ÿç§€æ´²å¾·å•†æ‘é•‡é“¶è¡Œ","å±±ä¸œæ²¾åŒ–é’äº‘æ‘é•‡é“¶è¡Œ","ä¹é™µåœ†èæ‘é•‡é“¶è¡Œ","å¾·å·é™µåŸåœ†èæ‘é•‡é“¶è¡Œ","å¹³åŸåœ†èæ‘é•‡é“¶è¡Œ","æ­¦åŸåœ†èæ‘é•‡é“¶è¡Œ","æ²‚æºåšå•†æ‘é•‡é“¶è¡Œ","å¤§æ–°é“¶è¡Œï¼ˆä¸­å›½ï¼‰æœ‰é™å…¬å¸","æµå—é•¿æ¸…æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","æµå—æ§è«æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","å®é˜³æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","ä¸œå¹³æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","æ³°å®‰æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","æ—¥ç…§æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","ä¸Šæµ·æ¾æ±Ÿå¯Œæ˜æ‘é•‡é“¶è¡Œ","å¤©æ°´ç§¦å·é•¿é“¶æ‘é•‡é“¶è¡Œ","æ­£é˜³ç‰å·æ‘é•‡é“¶è¡Œ","è¾½å®å¤§çŸ³æ¡¥éš†ä¸°æ‘é•‡é“¶è¡Œ","é‚å¹³ä¸­åŸæ‘é•‡é“¶è¡Œ","æ–°ä¹¡ä¸­åŸæ‘é•‡é“¶è¡Œ","è™åŸé€šå•†æ‘é•‡é“¶è¡Œ","å±±è¥¿é“¶è¡Œ","å®‰å›¾å†œå•†æ‘é•‡é“¶è¡Œ","é€šæ¦†å†œå•†æ‘é•‡é“¶è¡Œ","å®å¤è¥¿å¤è´ºå…°å±±æ‘é•‡é“¶è¡Œ","é™•è¥¿å‘¨è‡³å†œç§‘æ‘é•‡é“¶è¡Œ","ä¸œèé•¿å®‰æ‘é•‡é“¶è¡Œ","é–å®‰ä¹é“¶æ‘é•‡é“¶è¡Œ","å´‡ä»ä¹é“¶æ‘é•‡é“¶è¡Œ","é•¿æ˜¥æœé˜³å’Œæ¶¦æ‘é•‡é“¶è¡Œ","æ¡¦å—èå…´æ‘é•‡é“¶è¡Œ","ä¸­æ±Ÿèå…´æ‘é•‡é“¶è¡Œ","å¹³å‡‰å´†å³’èå…´æ‘é•‡é“¶è¡Œ","æ­¦æ±‰ä¼—é‚¦é“¶è¡Œ","å–€å–‡æ²ç‰é¾™æ‘é•‡é“¶è¡Œ","è´µé˜³èŠ±æºªå»ºè®¾æ‘é•‡é“¶è¡Œ","æ¸…å¾æƒ æ°‘æ‘é•‡é“¶è¡Œ","å¹¿è¥¿æµ¦åŒ—å›½æ°‘æ‘é•‡é“¶è¡Œ","ä¸¹ä¸œé“¶è¡Œæ¸…ç®—ä¸­å¿ƒ","åŒ—äº¬ä¸­å…³æ‘é“¶è¡Œ","è¾½å®æŒ¯å…´é“¶è¡Œ","æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒºå†œæ‘ä¿¡ç”¨ç¤¾è”åˆç¤¾","ç›˜å±±å®‰æ³°æ‘é•‡é“¶è¡Œ","èŠœæ¹–åœ†èæ‘é•‡é“¶è¡Œ","æ±Ÿè¥¿å…´å›½æ–°åæ‘é•‡é“¶è¡Œ","ä¸œèå¸¸å¹³æ–°åæ‘é•‡é“¶è¡Œ","å®‰å¾½éœé‚±è”åˆæ‘é•‡é“¶è¡Œ","å®‰å¾½éœå±±è”åˆæ‘é•‡é“¶è¡Œ","å±±ä¸œä¸´æ·„æ±‡é‡‘æ‘é•‡é“¶è¡Œ","èŠåŸæ²ªå†œå•†æ‘é•‡é“¶è¡Œ","ä¸´æ¸…æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","é˜³è°·æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","èŒŒå¹³æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","å¨æµ·è“æµ·é“¶è¡Œ","æ°¸æ¸…å‰é“¶æ‘é•‡é“¶è¡Œ","è´µå®‰æ–°åŒºå‘å±•æ‘é•‡é“¶è¡Œ","çŸ³é˜¡é•¿å¾æ‘é•‡é“¶è¡Œ","ä¸ªæ—§æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","åµ©æ˜æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","æ˜†æ˜å®˜æ¸¡æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","è’™è‡ªæ²ªå†œå•†æ‘é•‡é“¶è¡Œ","å¼€è¿œæ²ªå†œå•†æ‘é•‡é“¶è¡Œ","å¼¥å‹’æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","å»ºæ°´æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","ä¿å±±éš†é˜³æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","ä¸´æ²§ä¸´ç¿”æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","ç‘ä¸½æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","é’å²›é»„å²›èˆœä¸°æ‘é•‡é“¶è¡Œ","éµä¹‰æ’­å·æ±‡éš†æ‘é•‡é“¶è¡Œ","éµä¹‰æ±‡å·é»”å…´æ‘é•‡é“¶è¡Œ","ä¿®æ–‡æ±Ÿæµ·æ‘é•‡é“¶è¡Œ","å«è¾‰å¯Œæ°‘æ‘é•‡é“¶è¡Œ","å¤©æ´¥æ»¨æµ·å¾·å•†æ‘é•‡é“¶è¡Œ","é•¿æ˜¥äºŒé“å†œå•†æ‘é•‡é“¶è¡Œ","ä¸œå±±æ¶¦é‘«æ‘é•‡é“¶è¡Œ","å¹³å’Œæ¶¦ä¸°æ‘é•‡é“¶è¡Œ","äº‘éœ„æ¶¦å‘æ‘é•‡é“¶è¡Œ","å‡¯é‡Œä¸œå—æ‘é•‡é“¶è¡Œ","è´µé˜³å°æ²³ç§‘æŠ€æ‘é•‡é“¶è¡Œ","é„¢é™µéƒ‘é“¶æ‘é•‡é“¶è¡Œ","å…­ç›˜æ°´é’Ÿå±±å‡‰éƒ½æ‘é•‡é“¶è¡Œ","å¹¿å…ƒå¸‚å‘å±•æ‘é•‡é“¶è¡Œ","æœ›è°Ÿå¯Œæ°‘æ‘é•‡é“¶è¡Œ","é•¿é¡ºå¯Œæ°‘æ‘é•‡é“¶è¡Œ","ç‹¬å±±å¯Œæ°‘æ‘é•‡é“¶è¡Œ","å…­ç›˜æ°´å…­æå¯Œæ°‘æ‘é•‡é“¶è¡Œ","æ™®å®šå¯Œæ°‘æ‘é•‡é“¶è¡Œ","ç´«äº‘å¯Œæ°‘æ‘é•‡é“¶è¡Œ","å°æ±Ÿå¯Œæ°‘æ‘é•‡é“¶è¡Œ","é„‚å°”å¤šæ–¯å¸‚ç½•å°æ‘é•‡é“¶è¡Œ","é„‚æ‰˜å…‹æ——æ±‡æ³½æ‘é•‡é“¶è¡Œ","å¹¿å·ç•ªç¦ºæ–°åæ‘é•‡é“¶è¡Œ","æµ™æ±Ÿå˜‰å–„è”åˆæ‘é•‡é“¶è¡Œ","æ™¯å¿ä¸°æºæ‘é•‡é“¶è¡Œ","æ£å¼ºä¸°æºæ‘é•‡é“¶è¡Œ","è¡¡æ°´å†€å·ä¸°æºæ‘é•‡é“¶è¡Œ","é›„å¿ä¸°æºæ‘é•‡é“¶è¡Œ","è¾½å®æµ·åŸé‡‘æµ·æ‘é•‡é“¶è¡Œ","æ­¦å†ˆå‘å±•æ‘é•‡é“¶è¡Œ","æ— é”¡é”¡å•†é“¶è¡Œ","æµ™æ±Ÿæµ¦æ±Ÿå˜‰é“¶æ‘é•‡é“¶è¡Œ","æ˜†æ˜æ™‹å®èä¸°æ‘é•‡é“¶è¡Œ","åº“å°”å‹’é“¶è¡Œ","å®‰å¾½å¯¿å¿è”åˆæ‘é•‡é“¶è¡Œ","å®‰å¾½æ­™å¿å˜‰é“¶æ‘é•‡é“¶è¡Œ","é„±é˜³æ’é€šæ‘é•‡é“¶è¡Œ","ä½™å¹²æ’é€šæ‘é•‡é“¶è¡Œ","æ¨ªå³°æ’é€šæ‘é•‡é“¶è¡Œ","ä¹æ±Ÿæ’é€šæ‘é•‡é“¶è¡Œ","æ­¦å®æ’é€šæ‘é•‡é“¶è¡Œ","æœ›æ±Ÿæ–°åæ‘é•‡é“¶è¡Œ","å®‰å¾½éƒæºªæ–°åæ‘é•‡é“¶è¡Œ","æµ™æ±Ÿé‚æ˜Œå¯Œæ°‘æ‘é•‡é“¶è¡Œ","ä¸­ç‰Ÿéƒ‘é“¶æ‘é•‡é“¶è¡Œ","å±±ä¸œåšå…´æ–°åæ‘é•‡é“¶è¡Œ","å¹³èˆ†ç‰å·æ‘é•‡é“¶è¡Œ","èˆé˜³ç‰å·æ‘é•‡é“¶è¡Œ","è®¸æ˜Œæ–°æµ¦æ‘é•‡é“¶è¡Œ","è¿œå®‰é‡‘è°·æ‘é•‡é“¶è¡Œ","äº”å³°é‡‘è°·æ‘é•‡é“¶è¡Œ","æ±Ÿè¥¿è£•æ°‘é“¶è¡Œ","å”å±±å¸‚ä¸°å—èˆœä¸°æ‘é•‡é“¶è¡Œ","å±±ä¸œä¸´æœèšä¸°æ‘é•‡é“¶è¡Œ","å®å¤æ°¸å®æ±‡å‘æ‘é•‡é“¶è¡Œ","æ²³å—æ ¾å·æ°‘ä¸°æ‘é•‡é“¶è¡Œ","å­Ÿæ´¥æ°‘ä¸°æ‘é•‡é“¶è¡Œ","é›„å¿ä¸°æºæ‘é•‡é“¶è¡Œ","è¥¿å®‰é•¿å®‰æ–°åæ‘é•‡é“¶è¡Œ","é“œå·è€€å·æ–°åæ‘é•‡é“¶è¡Œ","éš†å¾·å…­ç›˜å±±æ‘é•‡é“¶è¡Œ","æµ™æ±Ÿæ¾é˜³æ’é€šæ‘é•‡é“¶è¡Œ","ä¸­å±±å°æ¦„æ‘é•‡é“¶è¡Œ","æµ™æ±Ÿæ¸©å²­è”åˆæ‘é•‡é“¶è¡Œ","æµ™æ±Ÿäº‘å’Œè”åˆæ‘é•‡é“¶è¡Œ","é¦™æ²³ç›Šæ°‘æ‘é•‡é“¶è¡Œ","æµ™æ±Ÿæ³°é¡ºæ¸©é“¶æ‘é•‡é“¶è¡Œ","æµ™æ±Ÿä¸œé˜³å¯Œæ°‘æ‘é•‡é“¶è¡Œ","æµ™æ±Ÿç¼™äº‘è”åˆæ‘é•‡é“¶è¡Œ","é»‘é¾™æ±Ÿçœå†œæ‘ä¿¡ç”¨ç¤¾è”åˆç¤¾","ä»»ä¸˜æ‘é•‡é“¶è¡Œ","è¾½æ²ˆé“¶è¡Œ","ç»µç«¹æµ¦å‘æ‘é•‡é“¶è¡Œ","ä¸‡å®é‡‘è°·æ‘é•‡é“¶è¡Œ","æµå®è“æµ·æ‘é•‡é“¶è¡Œ","ä¹äº­èˆœä¸°æ‘é•‡é“¶è¡Œ","æ­¦å®‰æ‘é•‡é“¶è¡Œ","æ²³åŒ—è ¡å·åŒ—é“¶å†œæ‘å•†ä¸šé“¶è¡Œ","æ±Ÿè¥¿ç‘é‡‘å…‰å¤§æ‘é•‡é“¶è¡Œ","å¤©æ´¥å®æ²³æ‘é•‡é“¶è¡Œ","æ²§å·ç›å±±æ–°åæ‘é•‡é“¶è¡Œ","æ²§å·æµ·å…´æ–°åæ‘é•‡é“¶è¡Œ","å¤§æ´¼æ’ä¸°æ‘é•‡é“¶è¡Œ","æµ™æ±Ÿå…°æºªè¶Šå•†æ‘é•‡é“¶è¡Œ","æµ™æ±Ÿä¹‰ä¹Œè”åˆæ‘é•‡é“¶è¡Œ","å®ä¸°è±«ä¸°æ‘é•‡é“¶è¡Œ","å±±ä¸œå†åŸåœ†èæ‘é•‡é“¶è¡Œ","é™µå·å¿å¤ªè¡Œæ‘é•‡é“¶è¡Œ","å±±é˜´å¿å¤ªè¡Œæ‘é•‡é“¶è¡Œ","é«˜å¹³å¸‚å¤ªè¡Œæ‘é•‡é“¶è¡Œ","ä¾¯é©¬å¸‚å¤ªè¡Œæ‘é•‡é“¶è¡Œ","æ±¾è¥¿å¿å¤ªè¡Œæ‘é•‡é“¶è¡Œ","å¹³å¡˜å¯Œæ°‘æ‘é•‡é“¶è¡Œ","ä¸¹å¯¨å¯Œæ°‘æ‘é•‡é“¶è¡Œ","å‰‘æ²³å¯Œæ°‘æ‘é•‡é“¶è¡Œ","ç“®å®‰å¯Œæ°‘æ‘é•‡é“¶è¡Œ","ä¸‰éƒ½å¯Œæ°‘æ‘é•‡é“¶è¡Œ","è”æ³¢å¯Œæ°‘æ‘é•‡é“¶è¡Œ","æ˜Ÿå±•é“¶è¡Œï¼ˆä¸­å›½ï¼‰æœ‰é™å…¬å¸ä¸Šæµ·åˆ†è¡Œ","å®é™µå¾·å•†æ‘é•‡é“¶è¡Œ","é˜¿æ‹‰å–„å·¦æ——æ–¹å¤§æ‘é•‡é“¶è¡Œ","èŒƒå¿å¾·å•†æ‘é•‡é“¶è¡Œ","ä¸Šæµ·å¥‰è´¤æµ¦å‘æ‘é•‡é“¶è¡Œ","æ°‘æƒå¾·å•†æ‘é•‡é“¶è¡Œ","ç¢å¿å¾·å•†æ‘é•‡é“¶è¡Œ","æµ™æ±Ÿç‰ç¯æ°¸å…´æ‘é•‡é“¶è¡Œ","ä¸œè¾½å†œå•†æ‘é•‡é“¶è¡Œ","é‡‘å¯¨å¾½é“¶æ‘é•‡é“¶è¡Œ","æ— ä¸ºå¾½é“¶æ‘é•‡é“¶è¡Œ","å¼€å°æ–°ä¸œæ–¹æ‘é•‡é“¶è¡Œ","æ±‡ä¸°é“¶è¡Œ(ä¸­å›½)æœ‰é™å…¬å¸ä¸Šæµ·åˆ†è¡Œ","å¤©æ´¥åæ˜æ‘é•‡é“¶è¡Œ","å¹¿å·ç™½äº‘æ°‘æ³°æ‘é•‡é“¶è¡Œ","ç æµ·é¦™æ´²å…´ç¦æ‘é•‡é“¶è¡Œ","æ·±åœ³å®å®‰æ¡‚é“¶æ‘é•‡é“¶è¡Œ","å¤©æ´¥é™æµ·æ–°åæ‘é•‡é“¶è¡Œ","åŒ—äº¬å¹³è°·æ–°åæ‘é•‡é“¶è¡Œ","æµ™æ±Ÿé•¿å…´è”åˆæ‘é•‡é“¶è¡Œ","ä¸´é«˜æƒ ä¸°æ‘é•‡é“¶è¡Œ","ä¹ä¸œæƒ ä¸°æ‘é•‡é“¶è¡Œ","ä¸œæ–¹æƒ ä¸°æ‘é•‡é“¶è¡Œ","æ±Ÿé—¨æ–°ä¼šæ–°åæ‘é•‡é“¶è¡Œ","å‘¼å’Œæµ©ç‰¹å¸‚ç‰æ³‰è’™é“¶æ‘é•‡é“¶è¡Œ","åŒ…å¤´å¸‚æ˜†éƒ½ä»‘è’™é“¶æ‘é•‡é“¶è¡Œ","è´µé˜³å†œæ‘å•†ä¸šé“¶è¡Œ","å››å·é“¶è¡Œ","æµ™æ±Ÿæ´å¤´å¯Œæ°‘æ‘é•‡é“¶è¡Œ","æµ™æ±Ÿæµ·å®å¾·å•†æ‘é•‡é“¶è¡Œ","æµ™æ±Ÿå°å·è·¯æ¡¥å¯Œæ°‘æ‘é•‡é“¶è¡Œ","åŒ—äº¬æˆ¿å±±æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","ä¸Šæµ·å´‡æ˜æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","å®ä¹¡æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","é†´é™µæ²ªå†œå•†æ‘é•‡é“¶è¡Œ","è¡¡é˜³å¿æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","æ°¸å…´æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","æ¡‚é˜³æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","ä¸´æ¾§æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","æ¾§å¿æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","çŸ³é—¨æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","æ¶Ÿæºæ²ªå†œå•†æ‘é•‡é“¶è¡Œ","åŒå³°æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","æ…ˆåˆ©æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","é•¿æ²™æ˜Ÿæ²™æ²ªå†œå•†æ‘é•‡é“¶è¡Œ","æ·±å·ä¸°æºæ‘é•‡é“¶è¡Œ","è¥„åŸä¸­åŸæ‘é•‡é“¶è¡Œ","å°å‰å¾·å•†æ‘é•‡é“¶è¡Œ","å…´å’Œè’™å•†æ‘é•‡é“¶è¡Œ","æ±Ÿè¥¿è²èŠ±å¯Œæ°‘æ‘é•‡é“¶è¡Œ","æµšå¿éƒ‘é“¶æ‘é•‡é“¶è¡Œ","ç¦¹å·æ–°æ°‘ç”Ÿæ‘é•‡é“¶è¡Œ","æ±Ÿè¥¿èŠ¦æºªå¯Œæ°‘æ‘é•‡é“¶è¡Œ","èä¹¡å®‰æºå¯Œæ°‘æ‘é•‡é“¶è¡Œ","æ±Ÿè¥¿ä¸Šæ —å¯Œæ°‘æ‘é•‡é“¶è¡Œ","æ–°å¯†éƒ‘é“¶æ‘é•‡é“¶è¡Œ","æ±å·ç‰å·æ‘é•‡é“¶è¡Œ","æ–°éƒ‘éƒ‘é“¶æ‘é•‡é“¶è¡Œ","å¤§åŸèˆœä¸°æ‘é•‡é“¶è¡Œ","å¢æ°ä¸­åŸæ‘é•‡é“¶è¡Œ","ä¸­é‚®é‚®æƒ ä¸‡å®¶é“¶è¡Œ","åŒ—äº¬å¤§å…´ä¹é“¶æ‘é•‡é“¶è¡Œ","å“ˆå¯†å¸‚å•†ä¸šé“¶è¡Œ","ä½›å±±å—æµ·æ–°åæ‘é•‡é“¶è¡Œ","æ²¿æ²³é•¿å¾æ‘é•‡é“¶è¡Œ","é“œä»ä¸‡å±±é•¿å¾æ‘é•‡é“¶è¡Œ","å¾·æ±Ÿé•¿å¾æ‘é•‡é“¶è¡Œ","é»”è¥¿èŠ±éƒ½æ‘é•‡é“¶è¡Œ","å¤§åŒé“¶è¡Œ","æ±Ÿè‹é‚—æ±Ÿè”åˆæ‘é•‡é“¶è¡Œ","å°æ±Ÿé•¿å¾æ‘é•‡é“¶è¡Œ","æ¾æ¡ƒé•¿å¾æ‘é•‡é“¶è¡Œ","æ±Ÿå£é•¿å¾æ‘é•‡é“¶è¡Œ","ä¸Šè”¡æƒ æ°‘æ‘é•‡é“¶è¡Œ","æµ™æ±Ÿä½™æ­å¾·å•†æ‘é•‡é“¶è¡Œ","ä¸­å›½å†œä¸šå‘å±•é“¶è¡Œ","å®‰å¾½å½“æ¶‚æ–°åæ‘é•‡é“¶è¡Œ","å®‰å¾½å’Œå¿æ–°åæ‘é•‡é“¶è¡Œ","å—æ˜Œæ–°å»ºæ’é€šæ‘é•‡é“¶è¡Œ","ä¸°åŸé¡ºé“¶æ‘é•‡é“¶è¡Œ","æ¨Ÿæ ‘é¡ºé“¶æ‘é•‡é“¶è¡Œ","å±±ä¸œå•†æ²³æ±‡é‡‘æ‘é•‡é“¶è¡Œ","å±±ä¸œé«˜é’æ±‡é‡‘æ‘é•‡é“¶è¡Œ","æ˜†æ˜å®œè‰¯èä¸°æ‘é•‡é“¶è¡Œ","å®å¤é’é“œå³¡è´ºå…°å±±æ‘é•‡é“¶è¡Œ","å¤©æ´¥é‡‘åŸé“¶è¡Œ","å…°è¥¿å†œå•†æ‘é•‡é“¶è¡Œ","å“ˆå°”æ»¨é˜¿åŸå†œå•†æ‘é•‡é“¶è¡Œ","è¥¿å®‰é›å¡”æ’é€šæ‘é•‡é“¶è¡Œ","æ·‡å¿ä¸­åŸæ‘é•‡é“¶è¡Œ","æ¿®é˜³ä¸­åŸæ‘é•‡é“¶è¡Œ","è¥¿å¹³ä¸­åŸæ‘é•‡é“¶è¡Œ","ä¸Šæµ·æµ¦ä¸œæ’é€šæ‘é•‡é“¶è¡Œ","æ—å·ä¸­åŸæ‘é•‡é“¶è¡Œ","æ³Œé˜³ç‰å·æ‘é•‡é“¶è¡Œ","çµå®èä¸°æ‘é•‡é“¶è¡Œ","æ›²é–æƒ æ°‘æ‘é•‡é“¶è¡Œ","æ¥šé›„çº¢å¡”æ‘é•‡é“¶è¡Œ","ç‰æºªçº¢å¡”æ‘é•‡é“¶è¡Œ","æ–‡å±±æ°‘ä¸°æ‘é•‡é“¶è¡Œ","å®å¤æƒ å†œè´ºå…°å±±æ‘é•‡é“¶è¡Œ","éœ¸å·èˆœä¸°æ‘é•‡é“¶è¡Œ","å—æ´‹å•†ä¸šé“¶è¡Œï¼ˆä¸­å›½ï¼‰æœ‰é™å…¬å¸","é•¿è‘›è½©è¾•æ‘é•‡é“¶è¡Œ","å—å®æ±Ÿå—å›½æ°‘æ‘é•‡é“¶è¡Œ","æ¡‚æ—å›½æ°‘æ‘é•‡é“¶è¡Œ","é’æµ·çœå†œæ‘ä¿¡ç”¨ç¤¾","ç»¥é˜³é»”åŒ—æ‘é•‡é“¶è¡Œ","å¤§å‚å›æ—è‡ªæ²»å¿æ–°åæ‘é•‡é“¶è¡Œ","æ·±åœ³é¾™åæ–°åæ‘é•‡é“¶è¡Œ","æµ™æ±Ÿå¸¸å±±è”åˆæ‘é•‡é“¶è¡Œ","ä»æ€€è’™é“¶æ‘é•‡é“¶è¡Œ","é¹°æ½­æœˆæ¹–æ’é€šæ‘é•‡é“¶è¡Œ","ä¿¡é˜³å¹³æ¡¥ä¸­åŸæ‘é•‡é“¶è¡Œ","å®šå…´ä¸°æºæ‘é•‡é“¶è¡Œ","æµ™æ±Ÿä¸Šè™å¯Œæ°‘æ‘é•‡é“¶è¡Œ","æµ™æ±Ÿå®šæµ·å¾·å•†æ‘é•‡é“¶è¡Œ","æµ™æ±Ÿä»™å±…å¯Œæ°‘æ‘é•‡é“¶è¡Œ","ä¸œèåšè¡—åä¸šæ‘é•‡é“¶è¡Œ","å—æ±Ÿå†œç§‘æ‘é•‡é“¶è¡Œ","å¹³æ˜Œå†œç§‘æ‘é•‡é“¶è¡Œ","å®å¤ä¸­å®é’é“¶æ‘é•‡é“¶è¡Œ","æ¹–åŒ—è†é—¨æ‡åˆ€æ¥šå†œå•†æ‘é•‡é“¶è¡Œ","é„„åŸç‰¡ä¸¹æ‘é•‡é“¶è¡Œ","æ±Ÿè‹è‹å®é“¶è¡Œ","å¹¿è¥¿é’¦å·å¸‚é’¦å—å›½æ°‘æ‘é•‡é“¶è¡Œ","æµ·å—é“¶è¡Œ","é‡åº†ä¹é¾™å¡æ°‘æ³°æ‘é•‡é“¶è¡Œ","ä½›å±±é«˜æ˜é¡ºé“¶æ‘é•‡é“¶è¡Œ","å…‹æ‹‰ç›ä¾é‡‘é¾™å›½æ°‘æ‘é•‡é“¶è¡Œ","æ¦†æ ‘èå…´æ‘é•‡é“¶è¡Œ","æ·±åœ³å®å®‰èå…´æ‘é•‡é“¶è¡Œ","é‚å®å®‰å±…èå…´æ‘é•‡é“¶è¡Œ","æµ·å—ä¿äº­èå…´æ‘é•‡é“¶è¡Œ","å»¶å¯¿èå…´æ‘é•‡é“¶è¡Œ","é‡åº†å¸‚é…‰é˜³èå…´æ‘é•‡é“¶è¡Œ","æµ™æ±Ÿå¹³é˜³æµ¦å‘æ‘é•‡é“¶è¡Œ","çº³é›å¯Œæ°‘æ‘é•‡é“¶è¡Œ","é‡‘æ²™å¯Œæ°‘æ‘é•‡é“¶è¡Œ","å¤§æ–¹å¯Œæ°‘æ‘é•‡é“¶è¡Œ","å¨å®å¯Œæ°‘æ‘é•‡é“¶è¡Œ","èµ«ç« å¯Œæ°‘æ‘é•‡é“¶è¡Œ","è´µé˜³è§‚å±±æ¹–å¯Œæ°‘æ‘é•‡é“¶è¡Œ","è´µé˜³ä¹Œå½“å¯Œæ°‘æ‘é•‡é“¶è¡Œ","è´µé˜³äº‘å²©å¯Œæ°‘æ‘é•‡é“¶è¡Œ","è´µé˜³å—æ˜å¯Œæ°‘æ‘é•‡é“¶è¡Œ","å®‰é¡ºè¥¿ç§€å¯Œæ°‘æ‘é•‡é“¶è¡Œ","éµä¹‰çº¢èŠ±å²—å¯Œæ°‘æ‘é•‡é“¶è¡Œ","å¼€é˜³å¯Œæ°‘æ‘é•‡é“¶è¡Œ","ç¦æ³‰å¯Œæ°‘æ‘é•‡é“¶è¡Œ","å†Œäº¨å¯Œæ°‘æ‘é•‡é“¶è¡Œ"];

// äº¤æ˜“æ‰€APIé…ç½®
const EXCHANGE_API = {
  baseUrl: 'https://qcmpce.gzcj-szh.com/',
  params: {
    aid: '5',
    platform: 'h5',
    session_id: '6fa5369f83c623701b6d69d366d2f93d',  // é»˜è®¤session_id (ä»…ç”¨äºæ³¨å†Œ/ç™»å½•åˆå§‹è¯·æ±‚)
    pid: '0',
    scene: '1001'
  }
};

// ç”Ÿæˆéšæœºsession_id (ç”¨äºå¹¶å‘åœºæ™¯)
function generateSessionId() {
  return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
}

// ==================== æ–°æ¥å£é…ç½® ====================
// æ³¨æ„: ä»¥ä¸‹æ¥å£ä¸ºæ–°ç‰ˆAPI,å¾…æµç¨‹æ¢³ç†å®ŒæˆåéªŒè¯
const NEW_API = {
  baseUrl: 'http://1.95.91.139:9200',
  webUrl: 'http://1.95.91.139:8088'
};

// ==================== éªŒè¯ç æ¥å£ï¼ˆé¢„ç•™ï¼Œå¾…éªŒè¯ï¼‰====================
// ç”¨é€”ï¼šç™»å½•æ—¶è·å–å›¾å½¢éªŒè¯ç 
// æ¥å£åœ°å€ï¼šPOST http://1.95.91.139:9200/314322
app.post('/api/get-verify-code', async (req, res) => {
  try {
    const { imageCodeOn = true, app_id = 'qoRz2jvwG0HmaEfxr7lV' } = req.body;

    console.log('\n========== è·å–éªŒè¯ç  ==========');
    console.log('è¯·æ±‚å‚æ•°:', { imageCodeOn, app_id });

    const apiUrl = `${NEW_API.baseUrl}/314322`;
    
    const requestData = {
      imageCodeOn: imageCodeOn,
      app_id: app_id
    };

    console.log('[éªŒè¯ç ] å‘é€è¯·æ±‚åˆ°:', apiUrl);
    console.log('[éªŒè¯ç ] è¯·æ±‚æ•°æ®:', requestData);

    const response = await axios.post(apiUrl, requestData, {
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'Accept-Encoding': 'gzip, deflate',
        'Accept-Language': 'zh-CN,zh;q=0.9',
        'Origin': NEW_API.webUrl,
        'Referer': `${NEW_API.webUrl}/`,
        'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36'
      },
      timeout: 10000
    });

    console.log('[éªŒè¯ç ] å“åº”:', response.data);

    // è¿”å›ç»“æœ
    // error_no: "0" è¡¨ç¤ºæˆåŠŸ
    // varifyCode: éªŒè¯ç æ–‡æœ¬
    // imageCode: éªŒè¯ç å›¾ç‰‡(Base64)
    // token: éªŒè¯ä»¤ç‰Œ
    if (response.data && response.data.error_no === "0") {
      const responseData = {
        success: true,
        message: 'è·å–éªŒè¯ç æˆåŠŸ',
        data: {
          varifyCode: response.data.varifyCode,  // éªŒè¯ç æ–‡æœ¬ï¼ˆç”¨äºé™é»˜ç™»å½•ï¼‰
          captcha: response.data.imageCode,      // éªŒè¯ç å›¾ç‰‡ï¼ˆå…¼å®¹æ—§å­—æ®µåï¼‰
          imageCode: response.data.imageCode,    // éªŒè¯ç å›¾ç‰‡
          token: response.data.token,            // â­ é‡è¦ï¼šç”¨äºç™»å½•çš„ token
          error_info: response.data.error_info
        }
      };
      logApiResponse('è·å–éªŒè¯ç ', responseData);
      res.json(responseData);
    } else {
      const responseData = {
        success: false,
        message: response.data?.error_info || 'è·å–éªŒè¯ç å¤±è´¥',
        data: response.data
      };
      logApiResponse('è·å–éªŒè¯ç ', responseData);
      res.json(responseData);
    }

  } catch (error) {
    console.error('[éªŒè¯ç ] è¯·æ±‚å¤±è´¥:', error.message);
    console.error('[éªŒè¯ç ] é”™è¯¯è¯¦æƒ…:', error.response?.data || error.stack);
    
    // ç»Ÿä¸€è¿”å› 200 çŠ¶æ€ç ï¼Œé€šè¿‡ success å­—æ®µåˆ¤æ–­æˆåŠŸä¸å¦
    if (error.response) {
      res.status(200).json({
        success: false,
        message: error.response.data?.error_info || 'è·å–éªŒè¯ç å¤±è´¥',
        data: error.response.data
      });
    } else {
      res.status(200).json({
        success: false,
        message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•: ' + error.message,
        error: error.message
      });
    }
  }
});

// ==================== ç™»å½•æµç¨‹æ¥å£ ====================

// 1. è·å–RSAå…¬é’¥æ¥å£
// ç”¨é€”ï¼šè·å–RSAå…¬é’¥ç”¨äºå¯†ç åŠ å¯†
// æ¥å£åœ°å€ï¼šPOST http://1.95.91.139:9200/999999
app.post('/api/get-public-key', async (req, res) => {
  try {
    const { app_id = 'qoRz2jvwG0HmaEfxr7lV' } = req.body;

    console.log('\n========== è·å–RSAå…¬é’¥ ==========');
    console.log('app_id:', app_id);

    const apiUrl = `${NEW_API.baseUrl}/999999`;
    
    const requestData = {
      app_id: app_id
    };

    console.log('[è·å–å…¬é’¥] å‘é€è¯·æ±‚åˆ°:', apiUrl);
    console.log('[è·å–å…¬é’¥] è¯·æ±‚æ•°æ®:', requestData);

    const response = await axios.post(apiUrl, requestData, {
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'Accept-Encoding': 'gzip, deflate',
        'Accept-Language': 'zh-CN,zh;q=0.9',
        'Origin': NEW_API.webUrl,
        'Referer': `${NEW_API.webUrl}/`,
        'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Mobile Safari/537.36'
      },
      timeout: 10000
    });

    console.log('[è·å–å…¬é’¥] å“åº”:', response.data);

    // ErrorCode: "0" è¡¨ç¤ºæˆåŠŸ
    if (response.data && response.data.ErrorCode === '0') {
      res.json({
        success: true,
        message: response.data.ErrorMsg || 'è·å–æˆåŠŸ',
        data: {
          publicKey: response.data.data
        }
      });
    } else {
      res.json({
        success: false,
        message: response.data?.ErrorMsg || 'è·å–å…¬é’¥å¤±è´¥',
        data: response.data
      });
    }

  } catch (error) {
    console.error('[è·å–å…¬é’¥] è¯·æ±‚å¤±è´¥:', error.message);
    
    if (error.response) {
      res.status(200).json({
        success: false,
        message: error.response.data?.ErrorMsg || 'è·å–å…¬é’¥å¤±è´¥',
        data: error.response.data
      });
    } else {
      res.status(500).json({
        success: false,
        message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•',
        error: error.message
      });
    }
  }
});

// 2. ç”¨æˆ·ç™»å½•æ¥å£
// ç”¨é€”ï¼šç”¨æˆ·ç™»å½•éªŒè¯
// æ¥å£åœ°å€ï¼šPOST http://1.95.91.139:9200/306122
app.post('/api/user-login', async (req, res) => {
  try {
    const {
      token,
      pwdCode,        // RSAåŠ å¯†åçš„å¯†ç 
      userAccount,
      checkCode,      // å›¾å½¢éªŒè¯ç 
      publicKey,
      app_id = 'qoRz2jvwG0HmaEfxr7lV'
    } = req.body;

    console.log('\n========== ç”¨æˆ·ç™»å½• ==========');
    console.log('è´¦å·:', userAccount);
    console.log('éªŒè¯ç token:', token ? token.substring(0, 30) + '...' : 'æœªæä¾›');
    console.log('å›¾å½¢éªŒè¯ç :', checkCode);
    console.log('app_id:', app_id);
    console.log('publicKeyå‰50å­—ç¬¦:', publicKey ? publicKey.substring(0, 50) + '...' : 'æœªæä¾›');
    console.log('pwdCodeå‰50å­—ç¬¦:', pwdCode ? pwdCode.substring(0, 50) + '...' : 'æœªæä¾›');

    // æ•°æ®æ ¡éªŒ
    if (!token || !pwdCode || !userAccount || !checkCode || !publicKey) {
      return res.json({
        success: false,
        message: 'è¯·æä¾›å®Œæ•´çš„ç™»å½•ä¿¡æ¯'
      });
    }

    const apiUrl = `${NEW_API.baseUrl}/306122`;
    
    const requestData = {
      token: token,
      pwdCode: pwdCode,
      userAccount: userAccount,
      checkCode: checkCode,
      publicKey: publicKey,
      app_id: app_id
    };

    console.log('[ç”¨æˆ·ç™»å½•] å‘é€è¯·æ±‚åˆ°:', apiUrl);
    console.log('[ç”¨æˆ·ç™»å½•] è¯·æ±‚æ•°æ® (éšè—å¯†ç ):', {
      ...requestData,
      pwdCode: '***éšè—***'
    });

    const response = await axios.post(apiUrl, requestData, {
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'Accept-Encoding': 'gzip, deflate',
        'Accept-Language': 'zh-CN,zh;q=0.9',
        'Origin': NEW_API.webUrl,
        'Referer': `${NEW_API.webUrl}/`,
        'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Mobile Safari/537.36'
      },
      timeout: 15000
    });

    console.log('[ç”¨æˆ·ç™»å½•] å“åº”:', response.data);

    // åˆ¤æ–­ç™»å½•æ˜¯å¦æˆåŠŸ
    // error_no: "0" æˆ– "" è¡¨ç¤ºæˆåŠŸ
    // error_no: "-1" è¡¨ç¤ºå¤±è´¥
    if (response.data && response.data.data && response.data.data[0]) {
      const loginResult = response.data.data[0];
      const success = loginResult.error_no === '0' || loginResult.error_no === '';
      
      res.json({
        success: success,
        message: success ? 'ç™»å½•æˆåŠŸ' : (loginResult.error_info || 'ç™»å½•å¤±è´¥'),
        data: {
          user_id: loginResult.user_id,
          session_id: loginResult.session_id,
          user_token: loginResult.user_token,
          account: loginResult.account,
          error_no: loginResult.error_no,
          error_info: loginResult.error_info
        }
      });
    } else {
      res.json({
        success: false,
        message: 'ç™»å½•å¤±è´¥',
        data: response.data
      });
    }

  } catch (error) {
    console.error('[ç”¨æˆ·ç™»å½•] è¯·æ±‚å¤±è´¥:', error.message);
    
    if (error.response) {
      res.status(200).json({
        success: false,
        message: error.response.data?.error_info || 'ç™»å½•å¤±è´¥',
        data: error.response.data
      });
    } else {
      res.status(500).json({
        success: false,
        message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•',
        error: error.message
      });
    }
  }
});

// ==================== æ³¨å†Œæµç¨‹ - ç¬¬ä¸€æ­¥éª¤æ¥å£ï¼ˆé¢„ç•™ï¼Œå¾…éªŒè¯ï¼‰====================

// å­—æ®µå”¯ä¸€æ€§æ ¡éªŒæ¥å£ï¼ˆç™»å½•è´¦å·ã€é‚®ç®±ã€æ‰‹æœºå·ç­‰ï¼‰
// ç”¨é€”ï¼šæ ¡éªŒç”¨æˆ·è¾“å…¥çš„å­—æ®µå€¼æ˜¯å¦å·²è¢«å ç”¨
// æ¥å£åœ°å€ï¼šPOST http://1.95.91.139:9200/305722
app.post('/api/validate-field', async (req, res) => {
  try {
    const {
      attr_key,      // å­—æ®µåï¼šaccountï¼ˆç™»å½•è´¦å·ï¼‰, perEmailï¼ˆé‚®ç®±ï¼‰, cellPhoneï¼ˆæ‰‹æœºå·ï¼‰
      attr_value,    // å­—æ®µå€¼
      isFlat = false,
      form_id_l = 3,
      app_id = 'qoRz2jvwG0HmaEfxr7lV'
    } = req.body;

    console.log('\n========== å­—æ®µæ ¡éªŒ ==========');
    console.log('å­—æ®µå:', attr_key);
    console.log('å­—æ®µå€¼:', attr_value);

    const apiUrl = `${NEW_API.baseUrl}/305722`;

    const requestData = {
      isFlat: isFlat,
      form_id_l: form_id_l,
      attr_key: attr_key,
      attr_value: attr_value,
      app_id: app_id
    };

    console.log('[å­—æ®µæ ¡éªŒ] å‘é€è¯·æ±‚åˆ°:', apiUrl);
    console.log('[å­—æ®µæ ¡éªŒ] è¯·æ±‚æ•°æ®:', requestData);

    const response = await axios.post(apiUrl, requestData, {
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'Accept-Encoding': 'gzip, deflate',
        'Accept-Language': 'zh-CN,zh;q=0.9',
        'Origin': NEW_API.webUrl,
        'Referer': `${NEW_API.webUrl}/`,
        'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Mobile Safari/537.36'
      },
      timeout: 10000
    });

    console.log('[å­—æ®µæ ¡éªŒ] å“åº”:', response.data);

    // è¿”å›ç»“æœ
    // data[0].result: "S" è¡¨ç¤ºæ ¡éªŒæˆåŠŸï¼ˆå­—æ®µå¯ç”¨ï¼‰
    res.json({
      success: true,
      data: response.data.data
    });

  } catch (error) {
    console.error('[å­—æ®µæ ¡éªŒ] è¯·æ±‚å¤±è´¥:', error.message);

    if (error.response) {
      res.status(200).json({
        success: false,
        message: 'å­—æ®µæ ¡éªŒå¤±è´¥',
        data: error.response.data
      });
    } else {
      res.status(500).json({
        success: false,
        message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•',
        error: error.message
      });
    }
  }
});

// 2. äº¤æ˜“è¯„ä¼°ç­”é¢˜æ¥å£
// ç”¨é€”ï¼šæäº¤ç”¨æˆ·çš„é£é™©è¯„ä¼°é—®å·ç­”æ¡ˆ
// æ¥å£åœ°å€ï¼šPOST http://1.95.91.139:9200/314484
app.post('/api/risk-assessment', async (req, res) => {
  try {
    const {
      questionReuslt,
      type = 'riskConfigPerson',
      templateType = '124',
      app_id = 'qoRz2jvwG0HmaEfxr7lV'
    } = req.body;

    console.log('\n========== é£é™©è¯„ä¼°ç­”é¢˜ ==========');
    console.log('ç­”é¢˜ç»“æœ:', questionReuslt);
    console.log('è¯„ä¼°ç±»å‹:', type);
    console.log('æ¨¡æ¿ç±»å‹:', templateType);

    const apiUrl = `${NEW_API.baseUrl}/314484`;
    
    const requestData = {
      type: type,
      templateType: templateType,
      questionReuslt: questionReuslt,
      app_id: app_id
    };

    console.log('[é£é™©è¯„ä¼°] å‘é€è¯·æ±‚åˆ°:', apiUrl);
    console.log('[é£é™©è¯„ä¼°] è¯·æ±‚æ•°æ®:', requestData);

    const response = await axios.post(apiUrl, requestData, {
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'Accept-Encoding': 'gzip, deflate',
        'Accept-Language': 'zh-CN,zh;q=0.9',
        'Origin': NEW_API.webUrl,
        'Referer': `${NEW_API.webUrl}/`,
        'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Mobile Safari/537.36'
      },
      timeout: 10000
    });

    console.log('[é£é™©è¯„ä¼°] å“åº”:', response.data);

    // è¿”å›ç»“æœ
    // data[0].score: å¾—åˆ†
    // data[0].pass_score: åŠæ ¼åˆ†
    // data[0].error_no: "" è¡¨ç¤ºæˆåŠŸ
    if (response.data && response.data.data && response.data.data[0]) {
      const assessmentResult = response.data.data[0];
      const passed = parseInt(assessmentResult.score) >= parseInt(assessmentResult.pass_score);
      
      res.json({
        success: true,
        message: passed ? 'é£é™©è¯„ä¼°é€šè¿‡' : 'é£é™©è¯„ä¼°æœªé€šè¿‡',
        passed: passed,
        data: {
          score: assessmentResult.score,
          pass_score: assessmentResult.pass_score,
          error_info: assessmentResult.error_info,
          error_no: assessmentResult.error_no
        }
      });
    } else {
      res.json({
        success: false,
        message: 'é£é™©è¯„ä¼°å¤±è´¥',
        data: response.data
      });
    }

  } catch (error) {
    console.error('[é£é™©è¯„ä¼°] è¯·æ±‚å¤±è´¥:', error.message);
    
    if (error.response) {
      res.status(200).json({
        success: false,
        message: 'é£é™©è¯„ä¼°å¤±è´¥',
        data: error.response.data
      });
    } else {
      res.status(500).json({
        success: false,
        message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•',
        error: error.message
      });
    }
  }
});

// 3. æ³¨å†Œä¿¡æ¯ä¿å­˜æ¥å£
// ç”¨é€”ï¼šä¿å­˜ç”¨æˆ·æ³¨å†Œä¿¡æ¯ï¼ˆä½œç”¨å¾…å®šï¼Œå¯èƒ½æ˜¯ä¿å­˜ç¬¬ä¸€æ­¥éª¤çš„æ³¨å†Œæ•°æ®ï¼‰
// æ¥å£åœ°å€ï¼šPOST http://1.95.91.139:9200/314483
// âš ï¸ å·²åˆ é™¤ /api/save-register-info æ¥å£
// ç»Ÿä¸€ä½¿ç”¨ /api/save-registration-infoï¼ˆline 1723ï¼‰

// ==================== æ³¨å†Œæµç¨‹ - å¡«å†™æ³¨å†Œä¿¡æ¯ï¼ˆé¢„ç•™ï¼Œå¾…éªŒè¯ï¼‰====================

/*
 * æ³¨å†Œä¿¡æ¯å¡«å†™æµç¨‹è¯´æ˜ï¼š
 * 
 * ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ èº«ä»½è¯ç…§ç‰‡
 * - ä¸Šä¼ èº«ä»½è¯æ­£é¢ç…§ç‰‡ï¼Œè½¬æ¢ä¸ºbase64æ ¼å¼ï¼Œå¹¶è°ƒç”¨åå°æ¥å£
 * - ä¸Šä¼ èº«ä»½è¯åé¢ç…§ç‰‡ï¼Œè½¬æ¢ä¸ºbase64æ ¼å¼ï¼Œå¹¶è°ƒç”¨åå°æ¥å£
 * 
 * ç¬¬äºŒæ­¥ï¼šå¡«å†™ä¸ªäººåŸºæœ¬ä¿¡æ¯
 * - å§“åï¼šå¿…å¡«ï¼Œç”¨æˆ·è‡ªå¡«
 * - ç”µå­é‚®ç®±ï¼šå¿…å¡«ï¼Œæ ¼å¼æ ¡éªŒï¼Œç”¨æˆ·è‡ªå¡«
 * - è¯ä»¶ç±»å‹ï¼šå›ºå®šä¸º"èº«ä»½è¯"
 * - è¯ä»¶å·ç ï¼šå¿…å¡«ï¼Œèº«ä»½è¯æ ¼å¼æ ¡éªŒï¼Œç”¨æˆ·è‡ªå¡«
 * - åŒºåŸŸï¼šçœå¸‚åŒºä¸‰çº§è”åŠ¨ï¼Œç”¨æˆ·è‡ªå¡«
 * - è”ç³»åœ°å€ï¼šå¿…å¡«ï¼Œç”¨æˆ·è‡ªå¡«
 * 
 * ç¬¬ä¸‰æ­¥ï¼šè¡¥å……ä¿¡æ¯
 * - å›ºå®šå€¼ï¼š15779002477
 * 
 * ç¬¬å››æ­¥ï¼šè´¦æˆ·ä¿¡æ¯
 * - ç™»å½•è´¦å·ï¼šå¿…å¡«ï¼Œ4-20ä½è‹±æ–‡ã€æ•°å­—æˆ–è¿å­—ç¬¦ï¼Œç”¨æˆ·è‡ªå¡«
 * - ç™»å½•å¯†ç ï¼šå›ºå®šä¸º "aa112233"
 * - ç¡®è®¤å¯†ç ï¼šå›ºå®šä¸º "aa112233"
 * - æ‰‹æœºå·ç ï¼šä½¿ç”¨ç¬¬ä¸€æ­¥éª¤æäº¤çš„æ‰‹æœºå·
 * - éªŒè¯ç ï¼šå‘é€åˆ°æ‰‹æœºåå¡«å…¥
 * 
 * å¾…å®Œæˆï¼š
 * 1. OSSä¸Šä¼ æ¥å£ï¼ˆå·²æœ‰å·¥å…·ç±» utils/ossUploader.jsï¼‰
 * 2. å‘é€æ‰‹æœºéªŒè¯ç æ¥å£
 * 3. æäº¤å®Œæ•´æ³¨å†Œä¿¡æ¯æ¥å£
 * 4. çœå¸‚åŒºæ•°æ®æ¥å£
 */

// 4. å‘é€æ‰‹æœºéªŒè¯ç æ¥å£ï¼ˆé¢„ç•™ï¼Œå¾…éªŒè¯ï¼‰
// ç”¨é€”ï¼šå‘é€çŸ­ä¿¡éªŒè¯ç åˆ°ç”¨æˆ·æ‰‹æœº
// æ¥å£åœ°å€ï¼šPOST http://1.95.91.139:9200/306121
app.post('/api/send-sms-code', async (req, res) => {
  try {
    // â­ æ·»åŠ åŸå§‹è¯·æ±‚ä½“æ—¥å¿—
    console.log('\n========== å‘é€çŸ­ä¿¡éªŒè¯ç  ==========');
    console.log('ğŸ” [DEBUG] åŸå§‹è¯·æ±‚ä½“ req.body:', JSON.stringify(req.body, null, 2));
    console.log('ğŸ” [DEBUG] Content-Type:', req.get('Content-Type'));
    
    const {
      cell_phone,
      send_type = 'sms',
      biz_type = 'reg_mobile',
      app_id = 'qoRz2jvwG0HmaEfxr7lV'
    } = req.body;

    console.log('æ‰‹æœºå·:', cell_phone);
    console.log('æ‰‹æœºå·ç±»å‹:', typeof cell_phone);
    console.log('å‘é€ç±»å‹:', send_type);
    console.log('ä¸šåŠ¡ç±»å‹:', biz_type);

    // æ•°æ®æ ¡éªŒ
    if (!cell_phone) {
      console.error('âŒ [ERROR] æ‰‹æœºå·ä¸ºç©ºæˆ–undefined');
      return res.json({
        success: false,
        message: 'è¯·æä¾›æ‰‹æœºå·'
      });
    }

    // æ‰‹æœºå·æ ¼å¼æ ¡éªŒ
    const phoneRegex = /^1[3-9]\d{9}$/;
    if (!phoneRegex.test(cell_phone)) {
      return res.json({
        success: false,
        message: 'æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®'
      });
    }

    const apiUrl = `${NEW_API.baseUrl}/306121`;
    
    const requestData = {
      send_type: send_type,
      biz_type: biz_type,
      cell_phone: cell_phone,
      app_id: app_id
    };

    console.log('[å‘é€éªŒè¯ç ] å‘é€è¯·æ±‚åˆ°:', apiUrl);
    console.log('[å‘é€éªŒè¯ç ] è¯·æ±‚æ•°æ®:', requestData);

    const response = await axios.post(apiUrl, requestData, {
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'Accept-Encoding': 'gzip, deflate',
        'Accept-Language': 'zh-CN,zh;q=0.9',
        'Origin': NEW_API.webUrl,
        'Referer': `${NEW_API.webUrl}/`,
        'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Mobile Safari/537.36'
      },
      timeout: 10000
    });

    console.log('[å‘é€éªŒè¯ç ] å“åº”:', response.data);

    // è¿”å›ç»“æœ
    // data[0].error_no: "0" è¡¨ç¤ºå‘é€æˆåŠŸ
    // data[0].error_info: é”™è¯¯ä¿¡æ¯ï¼ˆä¸ºç©ºè¡¨ç¤ºæˆåŠŸï¼‰
    if (response.data && response.data.data && response.data.data[0]) {
      const result = response.data.data[0];
      
      if (result.error_no === "0") {
        res.json({
          success: true,
          message: 'éªŒè¯ç å‘é€æˆåŠŸ',
          data: {
            cell_phone: cell_phone,
            error_info: result.error_info
          }
        });
      } else {
        res.json({
          success: false,
          message: result.error_info || 'éªŒè¯ç å‘é€å¤±è´¥',
          data: result
        });
      }
    } else {
      res.json({
        success: false,
        message: 'éªŒè¯ç å‘é€å¤±è´¥',
        data: response.data
      });
    }

  } catch (error) {
    console.error('[å‘é€éªŒè¯ç ] è¯·æ±‚å¤±è´¥:', error.message);
    
    if (error.response) {
      res.status(200).json({
        success: false,
        message: 'éªŒè¯ç å‘é€å¤±è´¥',
        data: error.response.data
      });
    } else {
      res.status(500).json({
        success: false,
        message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•',
        error: error.message
      });
    }
  }
});

// ==================== æœªçŸ¥ä½œç”¨æ¥å£ç»„ï¼ˆé¢„ç•™ï¼Œå¾…éªŒè¯ï¼‰====================

// æœªçŸ¥æ¥å£1ï¼šä¿å­˜å®Œæ•´æ³¨å†Œæ•°æ®ï¼ˆé¢„ç•™ï¼Œå¾…éªŒè¯ï¼‰
// æ¥å£åœ°å€ï¼šPOST http://1.95.91.139:9200/314483


// æœªçŸ¥æ¥å£2ï¼šéªŒè¯ç æ ¡éªŒï¼ˆé¢„ç•™ï¼Œå¾…éªŒè¯ï¼‰
// æ¥å£åœ°å€ï¼šPOST http://1.95.91.139:9200/305703
// æ¨æµ‹ç”¨é€”ï¼šéªŒè¯ç”¨æˆ·è¾“å…¥çš„çŸ­ä¿¡éªŒè¯ç æ˜¯å¦æ­£ç¡®
app.post('/api/verify-sms-code', async (req, res) => {
  try {
    const {
      code,
      cell_phone,
      isFlat = false,
      app_id = 'qoRz2jvwG0HmaEfxr7lV'
    } = req.body;

    console.log('\n========== éªŒè¯çŸ­ä¿¡éªŒè¯ç  ==========');
    console.log('æ‰‹æœºå·:', cell_phone);
    console.log('éªŒè¯ç :', code);

    // æ•°æ®æ ¡éªŒ
    if (!code || !cell_phone) {
      return res.json({
        success: false,
        message: 'è¯·æä¾›éªŒè¯ç å’Œæ‰‹æœºå·'
      });
    }

    const apiUrl = `${NEW_API.baseUrl}/305703`;
    
    const requestData = {
      isFlat: isFlat,
      code: code,
      cell_phone: cell_phone,
      app_id: app_id
    };

    console.log('[éªŒè¯ç æ ¡éªŒ] å‘é€è¯·æ±‚åˆ°:', apiUrl);
    console.log('[éªŒè¯ç æ ¡éªŒ] è¯·æ±‚æ•°æ®:', requestData);

    const response = await axios.post(apiUrl, requestData, {
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'Accept-Encoding': 'gzip, deflate',
        'Accept-Language': 'zh-CN,zh;q=0.9',
        'Origin': NEW_API.webUrl,
        'Referer': `${NEW_API.webUrl}/`,
        'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Mobile Safari/537.36'
      },
      timeout: 10000
    });

    console.log('[éªŒè¯ç æ ¡éªŒ] å“åº”:', response.data);

    // è¿”å›ç»“æœ
    // data[0].result: "true" è¡¨ç¤ºéªŒè¯æˆåŠŸ
    if (response.data && response.data.data && response.data.data[0]) {
      const result = response.data.data[0];
      
      if (result.result === "true") {
        res.json({
          success: true,
          message: 'éªŒè¯ç æ ¡éªŒé€šè¿‡',
          data: result
        });
      } else {
        res.json({
          success: false,
          message: 'éªŒè¯ç é”™è¯¯',
          data: result
        });
      }
    } else {
      res.json({
        success: false,
        message: 'éªŒè¯ç æ ¡éªŒå¤±è´¥',
        data: response.data
      });
    }

  } catch (error) {
    console.error('[éªŒè¯ç æ ¡éªŒ] è¯·æ±‚å¤±è´¥:', error.message);
    
    if (error.response) {
      res.status(200).json({
        success: false,
        message: 'éªŒè¯ç æ ¡éªŒå¤±è´¥',
        data: error.response.data
      });
    } else {
      res.status(500).json({
        success: false,
        message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•',
        error: error.message
      });
    }
  }
});

// æ¨èäººè´¦å·éªŒè¯æ¥å£ï¼ˆé¢„ç•™åŠŸèƒ½ - åŒä¿é™©æœºåˆ¶ï¼‰
// ä¸»æ¥å£ï¼šPOST http://1.95.91.139:9200/306026
// å¤‡ç”¨æ¥å£ï¼šPOST http://1.95.91.139:8088/api/uc_92300/322103
// ç”¨é€”ï¼šéªŒè¯æ¨èäººè´¦å·ï¼ˆæ‰‹æœºå·ï¼‰æ˜¯å¦å­˜åœ¨
// è¯´æ˜ï¼šä¼˜å…ˆä½¿ç”¨æ–°æ¥å£(306026)ï¼Œå¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°æ—§æ¥å£(322103)ä½œä¸ºå¤‡ç”¨
app.post('/api/verify-recommender-account', async (req, res) => {
  try {
    const {
      account,           // æ¨èäººè´¦å·ï¼ˆæ‰‹æœºå·ï¼‰
      user_id = 'userReg',
      isFlat = false,
      app_id = 'qoRz2jvwG0HmaEfxr7lV'
    } = req.body;

    console.log('\n========== æ¨èäººè´¦å·éªŒè¯ï¼ˆåŒä¿é™©ï¼‰==========');
    console.log('æ¨èäººè´¦å·:', account);
    console.log('ç”¨æˆ·ID:', user_id);

    // æ•°æ®æ ¡éªŒ
    if (!account) {
      return res.json({
        success: false,
        message: 'è¯·æä¾›æ¨èäººè´¦å·'
      });
    }

    // ==================== ç¬¬ä¸€æ¬¡å°è¯•ï¼šæ–°æ¥å£ 306026 ====================
    console.log('[æ¨èäººéªŒè¯] å°è¯•æ–¹æ¡ˆ1: æ–°æ¥å£ POST /306026');

    try {
      const apiUrl = `${NEW_API.baseUrl}/306026`;
      const requestData = {
        isFlat: isFlat,
        account: account,
        user_id: user_id,
        app_id: app_id
      };

      console.log('[æ–¹æ¡ˆ1] å‘é€è¯·æ±‚åˆ°:', apiUrl);
      console.log('[æ–¹æ¡ˆ1] è¯·æ±‚æ•°æ®:', requestData);

      const response = await axios.post(apiUrl, requestData, {
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'Accept-Encoding': 'gzip, deflate',
          'Accept-Language': 'zh-CN,zh;q=0.9',
          'Origin': NEW_API.webUrl,
          'Referer': `${NEW_API.webUrl}/`,
          'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Mobile Safari/537.36'
        },
        timeout: 10000
      });

      console.log('[æ–¹æ¡ˆ1] å“åº”æˆåŠŸ:', response.data);

      // è¿”å›ç»“æœ
      // data[0].result: "" è¡¨ç¤ºéªŒè¯é€šè¿‡ï¼ˆæ¨èäººå­˜åœ¨ï¼‰
      if (response.data && response.data.data && response.data.data[0]) {
        const result = response.data.data[0];
        const isValid = result.result === "";

        console.log('[æ–¹æ¡ˆ1] âœ… éªŒè¯æˆåŠŸï¼Œä½¿ç”¨æ–°æ¥å£');
        return res.json({
          success: true,
          message: isValid ? 'æ¨èäººè´¦å·éªŒè¯é€šè¿‡' : 'æ¨èäººè´¦å·ä¸å­˜åœ¨',
          valid: isValid,
          apiUsed: 'NEW_API_306026',  // æ ‡è®°ä½¿ç”¨çš„æ¥å£
          data: result
        });
      }

      // å“åº”æ ¼å¼ä¸ç¬¦åˆé¢„æœŸï¼Œå°è¯•å¤‡ç”¨æ¥å£
      console.warn('[æ–¹æ¡ˆ1] âš ï¸ å“åº”æ ¼å¼å¼‚å¸¸ï¼Œåˆ‡æ¢åˆ°å¤‡ç”¨æ¥å£');
      throw new Error('å“åº”æ ¼å¼å¼‚å¸¸');

    } catch (newApiError) {
      console.error('[æ–¹æ¡ˆ1] âŒ æ–°æ¥å£è°ƒç”¨å¤±è´¥:', newApiError.message);
      console.log('[æ¨èäººéªŒè¯] åˆ‡æ¢åˆ°æ–¹æ¡ˆ2: æ—§æ¥å£ POST /322103');

      // ==================== ç¬¬äºŒæ¬¡å°è¯•ï¼šæ—§æ¥å£ 322103ï¼ˆå¤‡ç”¨ï¼‰====================
      try {
        const fallbackApiUrl = `${NEW_API.webUrl}/api/uc_92300/322103`;
        const fallbackRequestData = {
          recommend_mobile: account,
          curr_ip: generateRandomIP()  // ä½¿ç”¨éšæœºIP
        };

        console.log('[æ–¹æ¡ˆ2] å‘é€è¯·æ±‚åˆ°:', fallbackApiUrl);
        console.log('[æ–¹æ¡ˆ2] è¯·æ±‚æ•°æ®:', fallbackRequestData);

        const fallbackResponse = await axios.post(fallbackApiUrl, fallbackRequestData, {
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json, text/plain, */*',
            'Accept-Encoding': 'gzip, deflate',
            'Accept-Language': 'zh-CN,zh;q=0.9',
            'Origin': NEW_API.webUrl,
            'Referer': `${NEW_API.webUrl}/app-2b/`,
            'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Mobile Safari/537.36'
          },
          timeout: 10000
        });

        console.log('[æ–¹æ¡ˆ2] å“åº”æˆåŠŸ:', fallbackResponse.data);

        // è¿”å›ç»“æœ
        // data[0].result: "false" æˆ– "true"
        if (fallbackResponse.data && fallbackResponse.data.data && fallbackResponse.data.data[0]) {
          const result = fallbackResponse.data.data[0];
          const isValid = result.result === "true";

          console.log('[æ–¹æ¡ˆ2] âœ… éªŒè¯æˆåŠŸï¼Œä½¿ç”¨æ—§æ¥å£ï¼ˆå¤‡ç”¨ï¼‰');
          return res.json({
            success: true,
            message: isValid ? 'æ¨èäººè´¦å·éªŒè¯é€šè¿‡' : 'æ¨èäººè´¦å·ä¸å­˜åœ¨',
            valid: isValid,
            apiUsed: 'OLD_API_322103',  // æ ‡è®°ä½¿ç”¨çš„å¤‡ç”¨æ¥å£
            fallback: true,              // æ ‡è®°è¿™æ˜¯å¤‡ç”¨æ–¹æ¡ˆ
            data: result
          });
        }

        // å¤‡ç”¨æ¥å£ä¹Ÿè¿”å›å¼‚å¸¸æ ¼å¼
        throw new Error('å¤‡ç”¨æ¥å£å“åº”æ ¼å¼å¼‚å¸¸');

      } catch (fallbackError) {
        console.error('[æ–¹æ¡ˆ2] âŒ å¤‡ç”¨æ¥å£ä¹Ÿè°ƒç”¨å¤±è´¥:', fallbackError.message);

        // ä¸¤ä¸ªæ¥å£éƒ½å¤±è´¥äº†
        return res.status(200).json({
          success: false,
          message: 'æ¨èäººéªŒè¯å¤±è´¥ï¼ˆä¸»å¤‡æ¥å£å‡ä¸å¯ç”¨ï¼‰',
          error: {
            newApi: newApiError.message,
            oldApi: fallbackError.message
          }
        });
      }
    }

  } catch (error) {
    console.error('[æ¨èäººéªŒè¯] ç³»ç»Ÿé”™è¯¯:', error.message);
    return res.status(500).json({
      success: false,
      message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•',
      error: error.message
    });
  }
});

// ==================== å·²åºŸå¼ƒæ¥å£ ====================
// âš ï¸ æ—§ç‰ˆæ¨èäººéªŒè¯æ¥å£ /api/verify-recommend-mobile å·²åºŸå¼ƒ
// åŸæ¥å£ï¼šPOST http://1.95.91.139:8088/api/uc_92300/322103
// åºŸå¼ƒåŸå› ï¼šä½¿ç”¨æ—§çš„ç”¨æˆ·ä¸­å¿ƒç³»ç»Ÿ(uc_92300)ï¼Œéœ€è¦IPåœ°å€å‚æ•°ï¼Œç«¯å£ä¸ç»Ÿä¸€
// âœ… è¯·ä½¿ç”¨æ–°ç‰ˆæ¥å£: /api/verify-recommender-account (æ”¯æŒåŒä¿é™©æœºåˆ¶)

// æ¥å£4ï¼šå¯åŠ¨ç”µå­åˆåŒå®åè®¤è¯ï¼ˆé¢„ç•™ï¼Œå¾…éªŒè¯ï¼‰
// æ¥å£åœ°å€ï¼šPOST http://1.95.91.139:9200/314466
// ç”¨é€”ï¼šè·å–ç”µå­åˆåŒå®åè®¤è¯URLï¼ˆasign.cnï¼‰
// è¯´æ˜ï¼šè¿”å›çš„URLæŒ‡å‘ç”µå­åˆåŒé¡µé¢ï¼Œç”¨æˆ·åœ¨è¯¥é¡µé¢å®Œæˆè¿è¥å•†ä¸‰è¦ç´ è®¤è¯æˆ–äººè„¸è¯†åˆ«
// è¿”å›æ•°æ®ï¼š{ id, biz_id, url }
app.post('/api/start-identity-verify', async (req, res) => {
  try {
    const {
      name,
      id_card_no,
      mobile,
      user_type = '2',
      from = 'app',
      isFlat = false,
      app_id = 'qoRz2jvwG0HmaEfxr7lV'
    } = req.body;

    console.log('\n========== å¯åŠ¨å®åè®¤è¯ ==========');
    console.log('å§“å:', name);
    console.log('èº«ä»½è¯å·:', id_card_no);
    console.log('æ‰‹æœºå·:', mobile);

    // æ•°æ®æ ¡éªŒ
    if (!name || !id_card_no || !mobile) {
      return res.json({
        success: false,
        message: 'è¯·æä¾›å®Œæ•´çš„å®åä¿¡æ¯'
      });
    }

    const apiUrl = `${NEW_API.baseUrl}/314466`;
    
    const requestData = {
      isFlat: isFlat,
      user_type: user_type,
      id_card_no: id_card_no,
      mobile: mobile,
      name: name,
      from: from,
      app_id: app_id
    };

    console.log('[å¯åŠ¨å®å] å‘é€è¯·æ±‚åˆ°:', apiUrl);
    console.log('[å¯åŠ¨å®å] è¯·æ±‚æ•°æ®:', requestData);

    const response = await axios.post(apiUrl, requestData, {
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'Accept-Encoding': 'gzip, deflate',
        'Accept-Language': 'zh-CN,zh;q=0.9',
        'Origin': NEW_API.webUrl,
        'Referer': `${NEW_API.webUrl}/`,
        'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Mobile Safari/537.36'
      },
      timeout: 15000
    });

    console.log('[å¯åŠ¨å®å] å“åº”:', response.data);

    // è¿”å›ç»“æœ
    // data[0].code: "200" è¡¨ç¤ºæˆåŠŸ
    // data[0].data[0].url: ç”µå­åˆåŒå®åè®¤è¯é¡µé¢URLï¼ˆasign.cnï¼‰
    // data[0].data[0].biz_id: ä¸šåŠ¡ID
    // data[0].data[0].id: è®¤è¯ID
    // 
    // ç”¨æˆ·éœ€è¦è·³è½¬åˆ°è¿”å›çš„URLå®Œæˆç”µå­åˆåŒå®åè®¤è¯æµç¨‹ï¼ŒåŒ…æ‹¬ï¼š
    // - è¿è¥å•†ä¸‰è¦ç´ è®¤è¯ï¼ˆå‘é€çŸ­ä¿¡éªŒè¯ç ï¼‰
    // - æˆ–äººè„¸è¯†åˆ«è®¤è¯
    if (response.data && response.data.data && response.data.data[0]) {
      const result = response.data.data[0];
      
      if (result.code === "200" && result.data && result.data[0]) {
        const verifyData = result.data[0];
        res.json({
          success: true,
          message: result.msg || 'è¯·æ±‚æˆåŠŸ',
          data: {
            id: verifyData.id,
            biz_id: verifyData.biz_id,
            url: verifyData.url,
            msg: result.msg
          }
        });
      } else {
        res.json({
          success: false,
          message: result.msg || 'å¯åŠ¨å®åè®¤è¯å¤±è´¥',
          data: result
        });
      }
    } else {
      res.json({
        success: false,
        message: 'å¯åŠ¨å®åè®¤è¯å¤±è´¥',
        data: response.data
      });
    }

  } catch (error) {
    console.error('[å¯åŠ¨å®å] è¯·æ±‚å¤±è´¥:', error.message);
    
    if (error.response) {
      res.status(200).json({
        success: false,
        message: 'å¯åŠ¨å®åè®¤è¯å¤±è´¥',
        data: error.response.data
      });
    } else {
      res.status(500).json({
        success: false,
        message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•',
        error: error.message
      });
    }
  }
});

// ==================== ç”µå­åˆåŒå®åè®¤è¯æµç¨‹è¯´æ˜ ====================

/*
 * ç”µå­åˆåŒå®åè®¤è¯æµç¨‹ï¼ˆasign.cnï¼‰ï¼š
 * 
 * 1. ç”¨æˆ·ç‚¹å‡»"æ„æ„¿è®¤è¯"æŒ‰é’®
 * 2. è°ƒç”¨ /api/start-identity-verify (314466) è·å–ç”µå­åˆåŒå®åè®¤è¯URL
 * 3. è·³è½¬åˆ° asign.cn ç”µå­åˆåŒå®åè®¤è¯é¡µé¢
 * 4. ç”¨æˆ·åœ¨ç”µå­åˆåŒé¡µé¢é€‰æ‹©è®¤è¯æ–¹å¼ï¼š
 *    - è¿è¥å•†ä¸‰è¦ç´ è®¤è¯ï¼ˆå‘é€çŸ­ä¿¡éªŒè¯ç ï¼‰
 *    - æˆ–äººè„¸è¯†åˆ«è®¤è¯ï¼ˆè°ƒç”¨é˜¿é‡Œäº‘äººè„¸è¯†åˆ«ï¼‰
 * 5. å®Œæˆè®¤è¯åï¼Œé¡µé¢è¿”å›è®¤è¯ç»“æœ
 * 
 * æ³¨æ„ï¼š
 * - è¿”å›çš„URLæ˜¯ç”µå­åˆåŒé¡µé¢ï¼Œä¸æ˜¯é˜¿é‡Œäº‘äººè„¸è¯†åˆ«é¡µé¢
 * - å¦‚æœç”¨æˆ·é€‰æ‹©äººè„¸è¯†åˆ«ï¼Œç”µå­åˆåŒé¡µé¢å†…éƒ¨ä¼šè°ƒç”¨é˜¿é‡Œäº‘æ¥å£
 * - é˜¿é‡Œäº‘æ¥å£ï¼ˆcloudauth-device.aliyuncs.comï¼‰ç”±asign.cné¡µé¢è°ƒç”¨ï¼Œæˆ‘ä»¬çš„æœåŠ¡å™¨ä¸ç›´æ¥è°ƒç”¨
 */

// é˜¿é‡Œäº‘å®åè®¤è¯æ¥å£1ï¼šè®¾å¤‡é…ç½®è·å–ï¼ˆæµç¨‹è®°å½•ï¼‰
// æ¥å£åœ°å€ï¼šPOST https://cloudauth-device.aliyuncs.com/
// Action: Log1
// ç”¨é€”ï¼šè·å–è®¾å¤‡é…ç½®ä¿¡æ¯ï¼Œç”¨äºåç»­çš„è®¾å¤‡æ£€æµ‹å’Œé£æ§
// è¯´æ˜ï¼šè¯¥æ¥å£ç”± asign.cn ç”µå­åˆåŒé¡µé¢å†…éƒ¨è°ƒç”¨ï¼ˆå½“ç”¨æˆ·é€‰æ‹©äººè„¸è¯†åˆ«è®¤è¯æ—¶ï¼‰
//      æˆ‘ä»¬çš„æœåŠ¡å™¨ä¸éœ€è¦ä»£ç†æ­¤æ¥å£
app.post('/api/aliyun-device-config', async (req, res) => {
  try {
    // æ³¨æ„ï¼šæ­¤æ¥å£ä»…ä½œä¸ºæµç¨‹è®°å½•
    // å®é™…ä½¿ç”¨æ—¶ï¼Œç”±å‰ç«¯è·³è½¬åˆ° asign.cn ç”µå­åˆåŒé¡µé¢
    // å¦‚æœç”¨æˆ·é€‰æ‹©äººè„¸è¯†åˆ«ï¼Œè¯¥é¡µé¢ä¼šè‡ªåŠ¨è°ƒç”¨é˜¿é‡Œäº‘æ¥å£
    
    console.log('\n========== é˜¿é‡Œäº‘è®¾å¤‡é…ç½®ï¼ˆæµç¨‹è®°å½•ï¼‰ ==========');
    console.log('âš ï¸ è¯¥æ¥å£ç”±ç”µå­åˆåŒé¡µé¢ï¼ˆasign.cnï¼‰è°ƒç”¨ï¼Œä¸éœ€è¦æœåŠ¡å™¨ä»£ç†');
    
    res.json({
      success: false,
      message: 'è¯¥æ¥å£ç”±ç”µå­åˆåŒé¡µé¢è°ƒç”¨ï¼Œè¯·ä½¿ç”¨ /api/start-identity-verify è·å–è·³è½¬URL',
      note: 'ç”¨æˆ·éœ€è¦è·³è½¬åˆ°è¿”å›çš„URLï¼ˆasign.cnï¼‰å®Œæˆç”µå­åˆåŒå®åè®¤è¯'
    });

  } catch (error) {
    console.error('[é˜¿é‡Œäº‘è®¾å¤‡é…ç½®] é”™è¯¯:', error.message);
    res.status(500).json({
      success: false,
      message: 'æ¥å£è¯´æ˜ï¼šè¯¥æ¥å£ç”±ç¬¬ä¸‰æ–¹é¡µé¢è°ƒç”¨',
      error: error.message
    });
  }
});

// é˜¿é‡Œäº‘å®åè®¤è¯æ¥å£2ï¼šæ—¥å¿—ä¸ŠæŠ¥ï¼ˆæµç¨‹è®°å½•ï¼‰
// æ¥å£åœ°å€ï¼šPOST https://cloudauth-device.aliyuncs.com/
// Action: Log2
// ç”¨é€”ï¼šä¸ŠæŠ¥è®¾å¤‡ä¿¡æ¯å’Œè®¤è¯æ—¥å¿—åˆ°é˜¿é‡Œäº‘
// è¯´æ˜ï¼šè¯¥æ¥å£ç”± asign.cn ç”µå­åˆåŒé¡µé¢å†…éƒ¨è°ƒç”¨ï¼ˆå½“ç”¨æˆ·é€‰æ‹©äººè„¸è¯†åˆ«è®¤è¯æ—¶ï¼‰
//      æˆ‘ä»¬çš„æœåŠ¡å™¨ä¸éœ€è¦ä»£ç†æ­¤æ¥å£
app.post('/api/aliyun-log-report', async (req, res) => {
  try {
    // æ³¨æ„ï¼šæ­¤æ¥å£ä»…ä½œä¸ºæµç¨‹è®°å½•
    // å®é™…ä½¿ç”¨æ—¶ï¼Œç”±å‰ç«¯è·³è½¬åˆ° asign.cn ç”µå­åˆåŒé¡µé¢
    // å¦‚æœç”¨æˆ·é€‰æ‹©äººè„¸è¯†åˆ«ï¼Œè¯¥é¡µé¢ä¼šè‡ªåŠ¨è°ƒç”¨é˜¿é‡Œäº‘æ¥å£
    
    console.log('\n========== é˜¿é‡Œäº‘æ—¥å¿—ä¸ŠæŠ¥ï¼ˆæµç¨‹è®°å½•ï¼‰ ==========');
    console.log('âš ï¸ è¯¥æ¥å£ç”±ç”µå­åˆåŒé¡µé¢ï¼ˆasign.cnï¼‰è°ƒç”¨ï¼Œä¸éœ€è¦æœåŠ¡å™¨ä»£ç†');
    
    res.json({
      success: false,
      message: 'è¯¥æ¥å£ç”±ç”µå­åˆåŒé¡µé¢è°ƒç”¨ï¼Œè¯·ä½¿ç”¨ /api/start-identity-verify è·å–è·³è½¬URL',
      note: 'ç”¨æˆ·éœ€è¦è·³è½¬åˆ°è¿”å›çš„URLï¼ˆasign.cnï¼‰å®Œæˆç”µå­åˆåŒå®åè®¤è¯'
    });

  } catch (error) {
    console.error('[é˜¿é‡Œäº‘æ—¥å¿—ä¸ŠæŠ¥] é”™è¯¯:', error.message);
    res.status(500).json({
      success: false,
      message: 'æ¥å£è¯´æ˜ï¼šè¯¥æ¥å£ç”±ç¬¬ä¸‰æ–¹é¡µé¢è°ƒç”¨',
      error: error.message
    });
  }
});

// ==================== ç”µå­åˆåŒç›¸å…³æ¥å£ï¼ˆé¢„ç•™ï¼Œå¾…éªŒè¯ï¼‰====================

/*
 * ç”µå­åˆåŒå®åè®¤è¯æµç¨‹è¯´æ˜ï¼ˆasign.cnï¼‰ï¼š
 * 
 * 1. è·å–è®¤è¯ä¿¡æ¯ï¼ˆauthTokenä»ä¹‹å‰çš„ /api/start-identity-verify æ¥å£è·å–ï¼‰
 * 2. è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆå§“åã€èº«ä»½è¯ã€æ‰‹æœºå·ç­‰ï¼‰
 * 3. é€‰æ‹©è®¤è¯æ–¹å¼ï¼ˆä¸ªäººè¿è¥å•†ä¸‰è¦ç´ è®¤è¯/äººè„¸æ´»ä½“è®¤è¯ï¼‰
 * 4. å‘é€éªŒè¯ç åˆ°æ‰‹æœº
 * 5. æäº¤éªŒè¯ç å®Œæˆè®¤è¯
 * 6. è·å–è®¤è¯ç»“æœ
 * 
 * æ³¨æ„ï¼šä»¥ä¸‹æ¥å£éƒ½æ˜¯asign.cnçš„ç¬¬ä¸‰æ–¹æ¥å£ï¼Œéœ€è¦å‰ç«¯è·³è½¬åˆ°asign.cné¡µé¢åè°ƒç”¨
 * æˆ‘ä»¬çš„æœåŠ¡å™¨å¯ä»¥ä»£ç†è¿™äº›æ¥å£ï¼Œä¹Ÿå¯ä»¥è®©å‰ç«¯ç›´æ¥è°ƒç”¨
 */

// ç”µå­åˆåŒæ¥å£1ï¼šè·å–è®¤è¯ä¿¡æ¯ï¼ˆé¢„ç•™ï¼Œå¾…éªŒè¯ï¼‰
// æ¥å£åœ°å€ï¼šPOST https://www.asign.cn/api/web/apiAuth/info/{authToken}
// ç”¨é€”ï¼šè·å–ç”¨æˆ·çš„å®åè®¤è¯ä¿¡æ¯å’Œå¯ç”¨çš„è®¤è¯æ–¹å¼
app.post('/api/e-contract-auth-info', async (req, res) => {
  try {
    const {
      authToken,
      isStepTwo = 0,
      isEnd = 0
    } = req.body;

    console.log('\n========== ç”µå­åˆåŒï¼šè·å–è®¤è¯ä¿¡æ¯ ==========');
    console.log('è®¤è¯ä»¤ç‰Œ:', authToken ? authToken.substring(0, 50) + '...' : 'æœªæä¾›');
    console.log('æ­¥éª¤:', isStepTwo === 0 ? 'ç¬¬ä¸€æ­¥' : 'ç¬¬äºŒæ­¥');
    console.log('æ˜¯å¦ç»“æŸ:', isEnd === 1 ? 'æ˜¯' : 'å¦');

    // æ•°æ®æ ¡éªŒ
    if (!authToken) {
      return res.json({
        success: false,
        message: 'è¯·æä¾›è®¤è¯ä»¤ç‰Œï¼ˆauthTokenï¼‰'
      });
    }

    const apiUrl = `https://www.asign.cn/api/web/apiAuth/info/${authToken}`;
    
    const requestData = {
      isStepTwo: isStepTwo,
      isEnd: isEnd
    };

    console.log('[è®¤è¯ä¿¡æ¯] å‘é€è¯·æ±‚åˆ°:', apiUrl);
    console.log('[è®¤è¯ä¿¡æ¯] è¯·æ±‚æ•°æ®:', requestData);

    const response = await axios.post(apiUrl, requestData, {
      headers: {
        'Content-Type': 'application/json;charset=UTF-8',
        'Accept': 'application/json, text/plain, */*',
        'Accept-Encoding': 'gzip, deflate, br, zstd',
        'Accept-Language': 'zh-CN,zh;q=0.9',
        'Origin': 'https://www.asign.cn',
        'Referer': 'https://www.asign.cn/m/',
        'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Mobile Safari/537.36'
      },
      timeout: 15000
    });

    console.log('[è®¤è¯ä¿¡æ¯] å“åº”:', response.data);

    // è¿”å›ç»“æœ
    // code: 1 è¡¨ç¤ºæˆåŠŸ
    // data.authTypeList: å¯ç”¨çš„è®¤è¯æ–¹å¼åˆ—è¡¨ï¼ˆ151-è¿è¥å•†ä¸‰è¦ç´ , 153-äººè„¸æ´»ä½“ï¼‰
    if (response.data && response.data.code === 1) {
      res.json({
        success: true,
        message: response.data.msg || 'è·å–æˆåŠŸ',
        data: response.data.data
      });
    } else {
      res.json({
        success: false,
        message: response.data?.msg || 'è·å–è®¤è¯ä¿¡æ¯å¤±è´¥',
        data: response.data
      });
    }

  } catch (error) {
    console.error('[è®¤è¯ä¿¡æ¯] è¯·æ±‚å¤±è´¥:', error.message);
    
    if (error.response) {
      res.status(200).json({
        success: false,
        message: error.response.data?.msg || 'è·å–è®¤è¯ä¿¡æ¯å¤±è´¥',
        data: error.response.data
      });
    } else {
      res.status(500).json({
        success: false,
        message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•',
        error: error.message
      });
    }
  }
});

// ç”µå­åˆåŒæ¥å£2ï¼šå‘é€éªŒè¯ç ï¼ˆé¢„ç•™ï¼Œå¾…éªŒè¯ï¼‰
// æ¥å£åœ°å€ï¼šPOST https://www.asign.cn/api/web/apiAuth/captcha/{authToken}
// ç”¨é€”ï¼šå‘é€éªŒè¯ç åˆ°ç”¨æˆ·æ‰‹æœºï¼ˆç”¨äºä¸ªäººè¿è¥å•†ä¸‰è¦ç´ è®¤è¯ï¼‰
app.post('/api/e-contract-send-captcha', async (req, res) => {
  try {
    const {
      authToken,
      authType = 151,  // 151-ä¸ªäººè¿è¥å•†ä¸‰è¦ç´ è®¤è¯, 153-äººè„¸æ´»ä½“è®¤è¯
      realName,
      idCardNo,
      mobile,
      bankCard = ''
    } = req.body;

    console.log('\n========== ç”µå­åˆåŒï¼šå‘é€éªŒè¯ç  ==========');
    console.log('è®¤è¯ä»¤ç‰Œ:', authToken ? authToken.substring(0, 50) + '...' : 'æœªæä¾›');
    console.log('è®¤è¯ç±»å‹:', authType);
    console.log('å§“å:', realName);
    console.log('æ‰‹æœºå·:', mobile);

    // æ•°æ®æ ¡éªŒ
    if (!authToken || !realName || !idCardNo || !mobile) {
      return res.json({
        success: false,
        message: 'è¯·æä¾›å®Œæ•´çš„è®¤è¯ä¿¡æ¯'
      });
    }

    const apiUrl = `https://www.asign.cn/api/web/apiAuth/captcha/${authToken}`;
    
    const requestData = {
      authType: authType,
      param: authToken,
      realName: realName,
      idCardNo: idCardNo,
      mobile: mobile,
      bankCard: bankCard
    };

    console.log('[å‘é€éªŒè¯ç ] å‘é€è¯·æ±‚åˆ°:', apiUrl);
    console.log('[å‘é€éªŒè¯ç ] è¯·æ±‚æ•°æ®:', requestData);

    const response = await axios.post(apiUrl, requestData, {
      headers: {
        'Content-Type': 'application/json;charset=UTF-8',
        'Accept': 'application/json, text/plain, */*',
        'Accept-Encoding': 'gzip, deflate, br, zstd',
        'Accept-Language': 'zh-CN,zh;q=0.9',
        'Origin': 'https://www.asign.cn',
        'Referer': 'https://www.asign.cn/m/',
        'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Mobile Safari/537.36'
      },
      timeout: 15000
    });

    console.log('[å‘é€éªŒè¯ç ] å“åº”:', response.data);

    // è¿”å›ç»“æœ
    // code: 1 è¡¨ç¤ºæˆåŠŸ
    if (response.data && response.data.code === 1) {
      res.json({
        success: true,
        message: response.data.msg || 'éªŒè¯ç å‘é€æˆåŠŸ',
        data: response.data.data
      });
    } else {
      res.json({
        success: false,
        message: response.data?.msg || 'éªŒè¯ç å‘é€å¤±è´¥',
        data: response.data
      });
    }

  } catch (error) {
    console.error('[å‘é€éªŒè¯ç ] è¯·æ±‚å¤±è´¥:', error.message);
    
    if (error.response) {
      res.status(200).json({
        success: false,
        message: error.response.data?.msg || 'éªŒè¯ç å‘é€å¤±è´¥',
        data: error.response.data
      });
    } else {
      res.status(500).json({
        success: false,
        message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•',
        error: error.message
      });
    }
  }
});

// ç”µå­åˆåŒæ¥å£3ï¼šéªŒè¯ç æ ¡éªŒï¼ˆé¢„ç•™ï¼Œå¾…éªŒè¯ï¼‰
// æ¥å£åœ°å€ï¼šPOST https://www.asign.cn/api/web/apiAuth/captcha/verify/{authToken}
// ç”¨é€”ï¼šæäº¤éªŒè¯ç å®Œæˆä¸ªäººè¿è¥å•†ä¸‰è¦ç´ è®¤è¯
app.post('/api/e-contract-verify-captcha', async (req, res) => {
  try {
    const {
      authToken,
      captcha
    } = req.body;

    console.log('\n========== ç”µå­åˆåŒï¼šéªŒè¯ç æ ¡éªŒ ==========');
    console.log('è®¤è¯ä»¤ç‰Œ:', authToken ? authToken.substring(0, 50) + '...' : 'æœªæä¾›');
    console.log('éªŒè¯ç :', captcha);

    // æ•°æ®æ ¡éªŒ
    if (!authToken || !captcha) {
      return res.json({
        success: false,
        message: 'è¯·æä¾›è®¤è¯ä»¤ç‰Œå’ŒéªŒè¯ç '
      });
    }

    const apiUrl = `https://www.asign.cn/api/web/apiAuth/captcha/verify/${authToken}`;
    
    const requestData = {
      param: authToken,
      captcha: captcha
    };

    console.log('[éªŒè¯ç æ ¡éªŒ] å‘é€è¯·æ±‚åˆ°:', apiUrl);
    console.log('[éªŒè¯ç æ ¡éªŒ] è¯·æ±‚æ•°æ®:', requestData);

    const response = await axios.post(apiUrl, requestData, {
      headers: {
        'Content-Type': 'application/json;charset=UTF-8',
        'Accept': 'application/json, text/plain, */*',
        'Accept-Encoding': 'gzip, deflate, br, zstd',
        'Accept-Language': 'zh-CN,zh;q=0.9',
        'Origin': 'https://www.asign.cn',
        'Referer': 'https://www.asign.cn/m/',
        'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Mobile Safari/537.36'
      },
      timeout: 15000
    });

    console.log('[éªŒè¯ç æ ¡éªŒ] å“åº”:', response.data);

    // è¿”å›ç»“æœ
    // code: 1 è¡¨ç¤ºæˆåŠŸ
    // data.result: 1 è¡¨ç¤ºè®¤è¯æˆåŠŸ
    // data.type: è®¤è¯ç±»å‹æè¿°
    // data.bizId: ä¸šåŠ¡ID
    if (response.data && response.data.code === 1) {
      const result = response.data.data;
      res.json({
        success: true,
        message: result?.msg || response.data.msg || 'è®¤è¯æˆåŠŸ',
        authenticated: result?.result === 1,
        data: result
      });
    } else {
      res.json({
        success: false,
        message: response.data?.msg || 'éªŒè¯ç æ ¡éªŒå¤±è´¥',
        data: response.data
      });
    }

  } catch (error) {
    console.error('[éªŒè¯ç æ ¡éªŒ] è¯·æ±‚å¤±è´¥:', error.message);
    
    if (error.response) {
      res.status(200).json({
        success: false,
        message: error.response.data?.msg || 'éªŒè¯ç æ ¡éªŒå¤±è´¥',
        data: error.response.data
      });
    } else {
      res.status(500).json({
        success: false,
        message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•',
        error: error.message
      });
    }
  }
});

// ç”µå­åˆåŒæ¥å£4ï¼šè·å–è®¤è¯é…ç½®ï¼ˆé¢„ç•™ï¼Œå¾…éªŒè¯ï¼‰
// æ¥å£åœ°å€ï¼šPOST https://www.asign.cn/api/web/apiAuth/settings/{authToken}
// ç”¨é€”ï¼šè·å–è®¤è¯é¡µé¢çš„é…ç½®ä¿¡æ¯ï¼ˆæ ‡é¢˜ã€é¢œè‰²ã€Logoç­‰ï¼‰
app.post('/api/e-contract-auth-settings', async (req, res) => {
  try {
    const {
      authToken
    } = req.body;

    console.log('\n========== ç”µå­åˆåŒï¼šè·å–è®¤è¯é…ç½® ==========');
    console.log('è®¤è¯ä»¤ç‰Œ:', authToken ? authToken.substring(0, 50) + '...' : 'æœªæä¾›');

    // æ•°æ®æ ¡éªŒ
    if (!authToken) {
      return res.json({
        success: false,
        message: 'è¯·æä¾›è®¤è¯ä»¤ç‰Œ'
      });
    }

    const apiUrl = `https://www.asign.cn/api/web/apiAuth/settings/${authToken}`;

    console.log('[è®¤è¯é…ç½®] å‘é€è¯·æ±‚åˆ°:', apiUrl);

    const response = await axios.get(apiUrl, {
      headers: {
        'Accept': 'application/json, text/plain, */*',
        'Accept-Encoding': 'gzip, deflate, br, zstd',
        'Accept-Language': 'zh-CN,zh;q=0.9',
        'Origin': 'https://www.asign.cn',
        'Referer': 'https://www.asign.cn/m/',
        'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Mobile Safari/537.36'
      },
      timeout: 10000
    });

    console.log('[è®¤è¯é…ç½®] å“åº”:', response.data);

    // è¿”å›ç»“æœ
    // code: 1 è¡¨ç¤ºæˆåŠŸ
    // data.title: é¡µé¢æ ‡é¢˜ï¼ˆå¦‚ï¼šè´µå·èŒ¶äº¤ï¼‰
    // data.titleColor: æ ‡é¢˜é¢œè‰²
    // data.buttonColor: æŒ‰é’®é¢œè‰²
    if (response.data && response.data.code === 1) {
      res.json({
        success: true,
        message: response.data.msg || 'è·å–æˆåŠŸ',
        data: response.data.data
      });
    } else {
      res.json({
        success: false,
        message: response.data?.msg || 'è·å–é…ç½®å¤±è´¥',
        data: response.data
      });
    }

  } catch (error) {
    console.error('[è®¤è¯é…ç½®] è¯·æ±‚å¤±è´¥:', error.message);
    
    if (error.response) {
      res.status(200).json({
        success: false,
        message: error.response.data?.msg || 'è·å–é…ç½®å¤±è´¥',
        data: error.response.data
      });
    } else {
      res.status(500).json({
        success: false,
        message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•',
        error: error.message
      });
    }
  }
});

// 6. è·å–çœå¸‚åŒºæ•°æ®æ¥å£ï¼ˆé¢„ç•™ï¼‰
// ç”¨é€”ï¼šè·å–çœå¸‚åŒºä¸‰çº§è”åŠ¨æ•°æ®
// æ¥å£åœ°å€ï¼šå¾…è¡¥å……
app.get('/api/get-regions', async (req, res) => {
  try {
    const { parentId = 0 } = req.query;

    console.log('\n========== è·å–çœå¸‚åŒºæ•°æ® ==========');
    console.log('çˆ¶çº§ID:', parentId);

    // TODO: å¾…è¡¥å……çœŸå®æ¥å£åœ°å€
    // const apiUrl = `${NEW_API.baseUrl}/[å¾…è¡¥å……]?parentId=${parentId}`;

    // ä¸´æ—¶è¿”å›ç¤ºä¾‹æ•°æ®ï¼ˆå¾…çœŸå®æ¥å£ç¡®è®¤ï¼‰
    const mockData = {
      provinces: ['å››å·çœ', 'å¹¿ä¸œçœ', 'åŒ—äº¬å¸‚', 'ä¸Šæµ·å¸‚'],
      cities: {
        'å››å·çœ': ['æˆéƒ½å¸‚', 'ç»µé˜³å¸‚', 'å¾·é˜³å¸‚'],
        'å¹¿ä¸œçœ': ['å¹¿å·å¸‚', 'æ·±åœ³å¸‚', 'ä¸œèå¸‚']
      },
      districts: {
        'æˆéƒ½å¸‚': ['é”¦æ±ŸåŒº', 'é’ç¾ŠåŒº', 'é‡‘ç‰›åŒº', 'æ­¦ä¾¯åŒº', 'æˆååŒº'],
        'å¹¿å·å¸‚': ['å¤©æ²³åŒº', 'è¶Šç§€åŒº', 'æµ·ç åŒº', 'è”æ¹¾åŒº']
      }
    };

    res.json({
      success: true,
      message: 'è·å–æˆåŠŸï¼ˆä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œå¾…çœŸå®æ¥å£è¡¥å……ï¼‰',
      data: mockData
    });

  } catch (error) {
    console.error('[è·å–çœå¸‚åŒº] è¯·æ±‚å¤±è´¥:', error.message);
    
    res.status(500).json({
      success: false,
      message: 'è·å–çœå¸‚åŒºæ•°æ®å¤±è´¥',
      error: error.message
    });
  }
});

// æ¥å£ï¼šæŸ¥è¯¢è®¤è¯çŠ¶æ€
// ç”¨é€”ï¼šè½®è¯¢æŸ¥è¯¢ç”¨æˆ·å®åè®¤è¯æ˜¯å¦å®Œæˆ
// æ¥å£åœ°å€ï¼šPOST http://1.95.91.139:9200/322102
app.post('/api/check-auth-status', async (req, res) => {
  try {
    const {
      isFlat = false,
      willuthId,
      id,
      app_id = 'qoRz2jvwG0HmaEfxr7lV'
    } = req.body;

    console.log('\n========== æŸ¥è¯¢è®¤è¯çŠ¶æ€ ==========');
    console.log('willuthId:', willuthId);
    console.log('id:', id);

    // æ•°æ®æ ¡éªŒ
    if (!willuthId || !id) {
      return res.json({
        success: false,
        message: 'è¯·æä¾›è®¤è¯ID'
      });
    }

    const apiUrl = 'http://1.95.91.139:9200/322102';

    console.log('[æŸ¥è¯¢è®¤è¯çŠ¶æ€] å‘é€è¯·æ±‚åˆ°:', apiUrl);
    console.log('[æŸ¥è¯¢è®¤è¯çŠ¶æ€] è¯·æ±‚å‚æ•°:', { isFlat, willuthId, id, app_id });

    const response = await axios.post(apiUrl, {
      isFlat,
      willuthId,
      id,
      app_id
    }, {
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json',
        'Accept-Encoding': 'gzip, deflate',
        'Accept-Language': 'zh-CN,zh;q=0.9',
        'Origin': 'http://1.95.91.139:8088',
        'Referer': 'http://1.95.91.139:8088/',
        'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Mobile Safari/537.36'
      },
      timeout: 10000
    });

    console.log('[æŸ¥è¯¢è®¤è¯çŠ¶æ€] å“åº”:', response.data);

    // è¿”å›ç»“æœ
    const responseData = {
      success: true,
      data: response.data.data || response.data
    };
    logApiResponse('æŸ¥è¯¢è®¤è¯çŠ¶æ€(322102)', responseData);
    res.json(responseData);

  } catch (error) {
    console.error('âŒ æŸ¥è¯¢è®¤è¯çŠ¶æ€å¤±è´¥:', error.message);

    res.status(500).json({
      success: false,
      message: 'æŸ¥è¯¢è®¤è¯çŠ¶æ€å¤±è´¥',
      error: error.message
    });
  }
});

// æ¥å£ï¼šä¿å­˜æ³¨å†Œä¿¡æ¯
// ç”¨é€”ï¼šä¿å­˜ç”¨æˆ·å®Œæ•´æ³¨å†Œæ•°æ®ï¼ˆè®¤è¯æˆåŠŸåè°ƒç”¨ï¼‰
// æ¥å£åœ°å€ï¼šPOST http://1.95.91.139:9200/314483
app.post('/api/save-registration-info', async (req, res) => {
  try {
    const {
      userType = "2",
      userRegAccount,
      userRegInfo,
      app_id = 'qoRz2jvwG0HmaEfxr7lV'
    } = req.body;

    console.log('\n========== ä¿å­˜æ³¨å†Œä¿¡æ¯ ==========');
    console.log('userType:', userType);
    console.log('userRegAccount:', userRegAccount);
    console.log('userRegInfo é•¿åº¦:', userRegInfo ? userRegInfo.length : 0);

    // æ•°æ®æ ¡éªŒ
    if (!userRegAccount || !userRegInfo) {
      return res.json({
        success: false,
        message: 'è¯·æä¾›å®Œæ•´çš„æ³¨å†Œä¿¡æ¯'
      });
    }

    const apiUrl = 'http://1.95.91.139:9200/314483';

    console.log('[ä¿å­˜æ³¨å†Œä¿¡æ¯] å‘é€è¯·æ±‚åˆ°:', apiUrl);

    const response = await axios.post(apiUrl, {
      userType,
      userRegAccount,
      userRegInfo,
      app_id
    }, {
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json',
        'Accept-Encoding': 'gzip, deflate',
        'Accept-Language': 'zh-CN,zh;q=0.9',
        'Origin': 'http://1.95.91.139:8088',
        'Referer': 'http://1.95.91.139:8088/',
        'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Mobile Safari/537.36'
      },
      timeout: 15000
    });

    console.log('[ä¿å­˜æ³¨å†Œä¿¡æ¯] å“åº”:', response.data);

    // æ£€æŸ¥è¿”å›ç»“æœ
    if (response.data && response.data.data && response.data.data.length > 0) {
      const result = response.data.data[0];
      if (result.error_no === "0") {
        const responseData = {
          success: true,
          message: 'ä¿å­˜æˆåŠŸ',
          data: result
        };
        logApiResponse('ä¿å­˜æ³¨å†Œä¿¡æ¯(314483)', responseData);
        res.json(responseData);
      } else {
        const responseData = {
          success: false,
          message: result.error_info || 'ä¿å­˜å¤±è´¥',
          data: result
        };
        logApiResponse('ä¿å­˜æ³¨å†Œä¿¡æ¯(314483)', responseData);
        res.json(responseData);
      }
    } else {
      const responseData = {
        success: true,
        data: response.data
      };
      logApiResponse('ä¿å­˜æ³¨å†Œä¿¡æ¯(314483)', responseData);
      res.json(responseData);
    }

  } catch (error) {
    console.error('âŒ ä¿å­˜æ³¨å†Œä¿¡æ¯å¤±è´¥:', error.message);

    res.status(500).json({
      success: false,
      message: 'ä¿å­˜æ³¨å†Œä¿¡æ¯å¤±è´¥',
      error: error.message
    });
  }
});

// æ¥å£ï¼šå®Œæˆæ³¨å†Œ
// ç”¨é€”ï¼šå®Œæˆæœ€ç»ˆæ³¨å†Œæµç¨‹ï¼ˆè®¤è¯æˆåŠŸåçš„æœ€åä¸€æ­¥ï¼‰
// æ¥å£åœ°å€ï¼šPOST http://1.95.91.139:9200/306118
app.post('/api/complete-registration', async (req, res) => {
  try {
    const {
      account,
      password,
      perEmail,
      areaInfo,
      areaInfos,
      personAddr,
      certType,
      certNo,
      cellPhone,
      regChkCode,
      imgAttach2,
      imgAttach7,
      partFullName,
      partCategories1,
      userTypeSecond,
      formCode,
      provinceCode,
      cityCode,
      districtCode,
      recommendMobile,
      publicKey,
      willId,
      app_id = 'qoRz2jvwG0HmaEfxr7lV',
      token
    } = req.body;

    console.log('\n========== å®Œæˆæ³¨å†Œ ==========');
    console.log('è´¦å·:', account);
    console.log('æ‰‹æœºå·:', cellPhone);
    console.log('willId:', willId);

    // æ•°æ®æ ¡éªŒ
    if (!account || !password || !cellPhone) {
      return res.json({
        success: false,
        message: 'è¯·æä¾›å®Œæ•´çš„æ³¨å†Œä¿¡æ¯'
      });
    }

    const apiUrl = 'http://1.95.91.139:9200/306118';

    console.log('[å®Œæˆæ³¨å†Œ] å‘é€è¯·æ±‚åˆ°:', apiUrl);

    const response = await axios.post(apiUrl, {
      account,
      password,
      perEmail,
      areaInfo,
      areaInfos,
      personAddr,
      certType,
      certNo,
      cellPhone,
      regChkCode,
      imgAttach2,
      imgAttach7,
      partFullName,
      partCategories1,
      userTypeSecond,
      formCode,
      provinceCode,
      cityCode,
      districtCode,
      recommendMobile,
      publicKey,
      willId,
      app_id,
      token
    }, {
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json',
        'Accept-Encoding': 'gzip, deflate',
        'Accept-Language': 'zh-CN,zh;q=0.9',
        'Origin': 'http://1.95.91.139:8088',
        'Referer': 'http://1.95.91.139:8088/',
        'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Mobile Safari/537.36'
      },
      timeout: 15000
    });

    console.log('[å®Œæˆæ³¨å†Œ] å“åº”:', response.data);

    // æ£€æŸ¥è¿”å›ç»“æœ
    if (response.data && response.data.data && response.data.data.length > 0) {
      const result = response.data.data[0];
      if (result.error_no === "0") {
        const responseData = {
          success: true,
          message: 'æ³¨å†Œå®Œæˆ',
          data: result
        };
        logApiResponse('å®Œæˆæ³¨å†Œ(306118)', responseData);
        res.json(responseData);
      } else {
        const responseData = {
          success: false,
          message: result.error_info || 'æ³¨å†Œå¤±è´¥',
          data: result
        };
        logApiResponse('å®Œæˆæ³¨å†Œ(306118)', responseData);
        res.json(responseData);
      }
    } else {
      const responseData = {
        success: true,
        data: response.data
      };
      logApiResponse('å®Œæˆæ³¨å†Œ(306118)', responseData);
      res.json(responseData);
    }

  } catch (error) {
    console.error('âŒ å®Œæˆæ³¨å†Œå¤±è´¥:', error.message);

    res.status(500).json({
      success: false,
      message: 'å®Œæˆæ³¨å†Œå¤±è´¥',
      error: error.message
    });
  }
});

// æ¥å£ï¼šè‡ªåŠ¨ç™»å½•
// ç”¨é€”ï¼šè®¤è¯æˆåŠŸåè‡ªåŠ¨ç™»å½•ç”¨æˆ·è´¦å·
// æ¥å£åœ°å€ï¼šPOST http://1.95.91.139:9200/306122
app.post('/api/auto-login', async (req, res) => {
  try {
    const {
      token,
      pwdCode,
      userAccount,
      checkCode,
      publicKey,
      app_id = 'qoRz2jvwG0HmaEfxr7lV'
    } = req.body;

    console.log('\n========== è‡ªåŠ¨ç™»å½• ==========');
    console.log('è´¦å·:', userAccount);
    console.log('éªŒè¯ç :', checkCode);
    console.log('token:', token);

    // æ•°æ®æ ¡éªŒ
    if (!token || !pwdCode || !userAccount || !checkCode) {
      return res.json({
        success: false,
        message: 'è¯·æä¾›å®Œæ•´çš„ç™»å½•ä¿¡æ¯'
      });
    }

    const apiUrl = 'http://1.95.91.139:9200/306122';

    console.log('[è‡ªåŠ¨ç™»å½•] å‘é€è¯·æ±‚åˆ°:', apiUrl);

    const response = await axios.post(apiUrl, {
      token,
      pwdCode,
      userAccount,
      checkCode,
      publicKey,
      app_id
    }, {
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json',
        'Accept-Encoding': 'gzip, deflate',
        'Accept-Language': 'zh-CN,zh;q=0.9',
        'Origin': 'http://1.95.91.139:8088',
        'Referer': 'http://1.95.91.139:8088/',
        'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Mobile Safari/537.36'
      },
      timeout: 15000
    });

    console.log('[è‡ªåŠ¨ç™»å½•] å“åº”:', response.data);

    // æ£€æŸ¥è¿”å›ç»“æœ
    if (response.data && response.data.data && response.data.data.length > 0) {
      const result = response.data.data[0];

      // æ£€æŸ¥æ˜¯å¦æœ‰ error_no å­—æ®µ
      if (result.error_no !== undefined) {
        if (result.error_no === "0") {
          // ç™»å½•æˆåŠŸ
          const responseData = {
            success: true,
            message: 'ç™»å½•æˆåŠŸ',
            data: {
              session_id: result.session_id || result.sessionId,
              user_id: result.user_id || result.userId,
              ...result
            }
          };
          logApiResponse('è‡ªåŠ¨ç™»å½•(306122)', responseData);
          res.json(responseData);
        } else {
          // ç™»å½•å¤±è´¥
          const responseData = {
            success: false,
            message: result.error_info || 'ç™»å½•å¤±è´¥',
            data: result
          };
          logApiResponse('è‡ªåŠ¨ç™»å½•(306122)', responseData);
          res.json(responseData);
        }
      } else {
        // æ²¡æœ‰ error_no å­—æ®µï¼Œç›´æ¥è¿”å›
        const responseData = {
          success: true,
          message: 'ç™»å½•æˆåŠŸ',
          data: result
        };
        logApiResponse('è‡ªåŠ¨ç™»å½•(306122)', responseData);
        res.json(responseData);
      }
    } else {
      const responseData = {
        success: true,
        data: response.data
      };
      logApiResponse('è‡ªåŠ¨ç™»å½•(306122)', responseData);
      res.json(responseData);
    }

  } catch (error) {
    console.error('âŒ è‡ªåŠ¨ç™»å½•å¤±è´¥:', error.message);

    res.status(500).json({
      success: false,
      message: 'è‡ªåŠ¨ç™»å½•å¤±è´¥',
      error: error.message
    });
  }
});

// ==================== æ­¥éª¤3ï¼šé“¶è¡Œå¡è®¤è¯ ====================

// è·å–ç”¨æˆ· fund_account æ¥å£
// æ¥å£åœ°å€ï¼šPOST http://1.95.91.139:9200/306351
app.post('/api/get-fund-account', async (req, res) => {
  try {
    const {
      exchangeId = 0,
      rootUserId,
      userId,
      sessionId,
      token,
      app_id = 'qoRz2jvwG0HmaEfxr7lV'
    } = req.body;

    console.log('\n========== è·å– Fund Account ==========');
    console.log('userId:', userId);
    console.log('sessionId:', sessionId);

    // æ•°æ®æ ¡éªŒ
    if (!userId || !sessionId) {
      return res.json({
        success: false,
        message: 'è¯·æä¾› userId å’Œ sessionId'
      });
    }

    const apiUrl = 'http://1.95.91.139:9200/306351';

    console.log('[è·å–FundAccount] å‘é€è¯·æ±‚åˆ°:', apiUrl);

    const requestData = {
      exchangeId,
      rootUserId: rootUserId || userId,
      userId,
      sessionId,
      token: token || '',
      app_id
    };

    console.log('[è·å–FundAccount] è¯·æ±‚æ•°æ®:', requestData);

    const response = await axios.post(apiUrl, requestData, {
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json',
        'Accept-Encoding': 'gzip, deflate',
        'Accept-Language': 'zh-CN,zh;q=0.9',
        'Origin': 'http://1.95.91.139:8088',
        'Referer': 'http://1.95.91.139:8088/',
        'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Mobile Safari/537.36'
      },
      timeout: 15000
    });

    console.log('[è·å–FundAccount] å“åº”:', JSON.stringify(response.data, null, 2));

    // è§£æå“åº”æ•°æ®
    if (response.data && response.data.data && response.data.data.length > 0) {
      const responseItem = response.data.data[0];

      // æ£€æŸ¥æ˜¯å¦æœ‰ items æ•°ç»„
      if (responseItem.items && responseItem.items.length > 0) {
        const fundAccountData = responseItem.items[0];
        const fundAccount = fundAccountData.fund_account;

        console.log('âœ… è·å–åˆ° fund_account:', fundAccount);

        const responseData = {
          success: true,
          message: 'è·å–æˆåŠŸ',
          data: {
            fund_account: fundAccount,
            client_name: fundAccountData.client_name,
            id_no: fundAccountData.id_no,
            mobile: fundAccountData.mobile,
            status: fundAccountData.status,
            full_data: fundAccountData
          }
        };

        logApiResponse('è·å–FundAccount(306351)', responseData);
        res.json(responseData);
      } else {
        // æ²¡æœ‰æ‰¾åˆ° fund_account
        const responseData = {
          success: false,
          message: 'æœªæ‰¾åˆ°ç”¨æˆ·çš„ fund_account',
          data: response.data
        };

        logApiResponse('è·å–FundAccount(306351)', responseData);
        res.json(responseData);
      }
    } else {
      const responseData = {
        success: false,
        message: 'å“åº”æ•°æ®æ ¼å¼é”™è¯¯',
        data: response.data
      };

      logApiResponse('è·å–FundAccount(306351)', responseData);
      res.json(responseData);
    }

  } catch (error) {
    console.error('âŒ è·å– fund_account å¤±è´¥:', error.message);

    res.status(500).json({
      success: false,
      message: 'è·å– fund_account å¤±è´¥',
      error: error.message
    });
  }
});

// ç»‘å¡æ”¶éªŒè¯ç æ¥å£
// æ¥å£åœ°å€ï¼šPOST http://1.95.91.139:8088/api/uc_92300/306684
app.post('/api/send-bank-sms-code', async (req, res) => {
  try {
    const {
      bank_code,
      bank_pro_code = 'ljyClearing',
      fund_account,  // å¿…é¡»ç”±å‰ç«¯æä¾›ï¼Œä¸è®¾ç½®é»˜è®¤å€¼
      action_type = '1',
      mobile,
      trans_code = '10000111',
      curr_ip = '192.168.186.17',
      session_id = '',  // æ¥æ”¶ session_id
      user_id = ''  // æ¥æ”¶ user_id
    } = req.body;

    console.log('\n========== ç»‘å¡æ”¶éªŒè¯ç  ==========');
    console.log('é“¶è¡Œä»£ç :', bank_code);
    console.log('èµ„é‡‘è´¦å·:', fund_account);
    console.log('æ‰‹æœºå·:', mobile);
    console.log('session_id:', session_id);
    console.log('user_id:', user_id);

    // æ•°æ®æ ¡éªŒ
    if (!bank_code || !mobile || !fund_account) {
      return res.json({
        success: false,
        message: 'è¯·æä¾›é“¶è¡Œä»£ç ã€èµ„é‡‘è´¦å·å’Œæ‰‹æœºå·'
      });
    }

    const apiUrl = 'http://1.95.91.139:8088/api/uc_92300/306684';

    const requestData = {
      bank_code,
      bank_pro_code,
      fund_account,
      action_type,
      mobile,
      trans_code,
      curr_ip
      // ä¸ä¼ é€’ session_id å’Œ user_idï¼ˆæ ¹æ®çœŸå® API è°ƒç”¨ï¼‰
    };

    console.log('[ç»‘å¡æ”¶éªŒè¯ç ] å‘é€è¯·æ±‚åˆ°:', apiUrl);
    console.log('[ç»‘å¡æ”¶éªŒè¯ç ] è¯·æ±‚æ•°æ®:', requestData);

    const response = await axios.post(apiUrl, requestData, {
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      timeout: 15000
    });

    console.log('[ç»‘å¡æ”¶éªŒè¯ç ] å“åº”:', response.data);

    // ç»Ÿä¸€æ—¥å¿—
    logApiResponse('ç»‘å¡æ”¶éªŒè¯ç (306684)', response.data);

    // æ£€æŸ¥è¿”å›ç»“æœ
    if (response.data && response.data.data && response.data.data.length > 0) {
      const result = response.data.data[0];

      if (result.enum_fund_code === '0000') {
        res.json({
          success: true,
          message: result.enum_fund_desc || 'éªŒè¯ç å‘é€æˆåŠŸ',
          data: result
        });
      } else {
        res.json({
          success: false,
          message: result.enum_fund_desc || 'éªŒè¯ç å‘é€å¤±è´¥',
          data: result
        });
      }
    } else {
      res.json({
        success: false,
        message: 'éªŒè¯ç å‘é€å¤±è´¥',
        data: response.data
      });
    }

  } catch (error) {
    console.error('âŒ ç»‘å¡æ”¶éªŒè¯ç å¤±è´¥:', error.message);

    res.status(500).json({
      success: false,
      message: 'éªŒè¯ç å‘é€å¤±è´¥',
      error: error.message
    });
  }
});

// æŸ¥è¯¢ç»‘å¡é“¶è¡Œé€šé“/é…ç½®æ¥å£ï¼ˆå‰ç½®è¾…åŠ©æ¥å£ï¼‰
// ä½œç”¨ï¼šåœ¨ç»‘å¡å‰è·å–æŸé“¶è¡Œçš„é€šé“çŠ¶æ€ã€è¥ä¸šæ—¶é—´ã€æ”¯æŒçš„é“¶è¡Œä»£ç ç­‰ä¿¡æ¯
// åŸå§‹æ¥å£ï¼šPOST http://1.95.91.139:9200/306401
// è°ƒç”¨æ—¶é€šå¸¸åªéœ€è¦æä¾›ç”¨æˆ·æ ‡è¯†ã€sessionã€tokenã€app_idã€‚
app.post('/api/query-bank-config', async (req, res) => {
  try {
    const {
      userId,
      sessionId,
      token,
      exchangeId = 0,
      app_id = 'qoRz2jvwG0HmaEfxr7lV'
    } = req.body;

    console.log('\n========== æŸ¥è¯¢ç»‘å¡é“¶è¡Œé€šé“é…ç½® ==========' );
    console.log('userId:', userId);
    console.log('sessionId:', sessionId ? sessionId.substring(0, 20) + '...' : 'æœªæä¾›');
    console.log('exchangeId:', exchangeId);

    if (!userId) {
      return res.json({ success: false, message: 'è¯·æä¾›ç”¨æˆ·ID userId' });
    }

    const apiUrl = `${NEW_API.baseUrl}/306401`;
    const requestData = {
      userId,
      sessionId: sessionId || '',
      exchangeId,
      token: token || '',
      app_id
    };

    console.log('[æŸ¥è¯¢ç»‘å¡é“¶è¡Œé€šé“é…ç½®] è¯·æ±‚åœ°å€:', apiUrl);
    console.log('[æŸ¥è¯¢ç»‘å¡é“¶è¡Œé€šé“é…ç½®] è¯·æ±‚æ•°æ®:', requestData);

    const response = await axios.post(apiUrl, requestData, {
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      timeout: 15000
    });

    console.log('[æŸ¥è¯¢ç»‘å¡é“¶è¡Œé€šé“é…ç½®] åŸå§‹å“åº”:', response.data);
    logApiResponse('æŸ¥è¯¢ç»‘å¡é“¶è¡Œé€šé“é…ç½®(306401)', response.data);

    if (response.data && response.data.data && response.data.data.length > 0) {
      res.json({
        success: true,
        message: 'æŸ¥è¯¢æˆåŠŸ',
        data: response.data.data
      });
    } else {
      res.json({
        success: false,
        message: 'æœªè·å–åˆ°é…ç½®æ•°æ®',
        data: response.data
      });
    }
  } catch (error) {
    console.error('âŒ æŸ¥è¯¢ç»‘å¡é“¶è¡Œé€šé“é…ç½®å¤±è´¥:', error.message);
    res.status(500).json({
      success: false,
      message: 'æŸ¥è¯¢å¤±è´¥',
      error: error.message
    });
  }
});

// æŸ¥è¯¢é“¶è¡Œæ”¯è¡Œæ¥å£
// æ¥å£åœ°å€: POST http://1.95.91.139:9200/306624
app.post('/api/query-bank-branch', async (req, res) => {
  try {
    const {
      bank_no,
      userId,
      sessionId,
      token,
      app_id = 'qoRz2jvwG0HmaEfxr7lV',
      isFlat = false,
      current_page = 1,
      page_size = 10,
      page_count = 10
    } = req.body;

    console.log('\n========== æŸ¥è¯¢é“¶è¡Œæ”¯è¡Œ ==========');
    console.log('é“¶è¡Œç¼–å·:', bank_no);
    console.log('ç”¨æˆ·ID:', userId);

    // Validate required fields
    if (!bank_no) {
      return res.json({
        success: false,
        message: 'è¯·æä¾›é“¶è¡Œç¼–å·'
      });
    }

    const apiUrl = 'http://1.95.91.139:9200/306624';

    const requestData = {
      isFlat,
      current_page,
      page_size,
      page_count,
      bank_no,
      userId: userId || '',
      sessionId: sessionId || '',
      token: token || '',
      app_id
    };

    console.log('[æŸ¥è¯¢é“¶è¡Œæ”¯è¡Œ] è¯·æ±‚å‚æ•°:', requestData);

    const response = await axios.post(apiUrl, requestData, {
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      timeout: 15000
    });

    console.log('[æŸ¥è¯¢é“¶è¡Œæ”¯è¡Œ] å“åº”:', response.data);
    logApiResponse('æŸ¥è¯¢é“¶è¡Œæ”¯è¡Œ(306624)', response.data);

    res.json({
      success: true,
      data: response.data
    });

  } catch (error) {
    console.error('âŒ æŸ¥è¯¢é“¶è¡Œæ”¯è¡Œå¤±è´¥:', error.message);
    res.status(500).json({
      success: false,
      message: 'æŸ¥è¯¢é“¶è¡Œæ”¯è¡Œå¤±è´¥',
      error: error.message
    });
  }
});

// é€‰æ‹©é“¶è¡Œæ¸ é“æ¥å£ï¼ˆæ–¹æ¡ˆäºŒï¼‰
// ä½œç”¨ï¼šæ ¹æ®ç”¨æˆ·æ ‡è¯†è·å–é“¶è¡Œæ¸ é“ä¿¡æ¯ï¼ˆæ¥å£è¿”å›å¯èƒ½ä¸ºåŠ å¯†ä¸²ï¼Œå…ˆé€ä¼ ä¾›å‰ç«¯/æŠ“åŒ…ï¼‰
// åŸå§‹æ¥å£ï¼šPOST http://1.95.91.139:9200/305897
app.post('/api/select-bank-channel-2', async (req, res) => {
  try {
    const {
      user_id,
      isFlat = false,
      token = '',
      sessionId = '',
      app_id = 'qoRz2jvwG0HmaEfxr7lV'
    } = req.body;

    console.log('\n========== é€‰æ‹©é“¶è¡Œæ¸ é“(æ–¹æ¡ˆäºŒ) ==========' );
    console.log('user_id:', user_id);
    console.log('sessionId:', sessionId ? sessionId.substring(0, 20) + '...' : 'æœªæä¾›');

    if (!user_id) {
      return res.json({ success: false, message: 'è¯·æä¾› user_id' });
    }

    const apiUrl = `${NEW_API.baseUrl}/305897`;
    const requestData = {
      user_id,
      isFlat,
      token,
      sessionId,
      app_id
    };

    console.log('[é€‰æ‹©é“¶è¡Œæ¸ é“-2] è¯·æ±‚åœ°å€:', apiUrl);
    console.log('[é€‰æ‹©é“¶è¡Œæ¸ é“-2] è¯·æ±‚æ•°æ®:', requestData);

    const response = await axios.post(apiUrl, requestData, {
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'Accept-Encoding': 'gzip, deflate',
        'Accept-Language': 'zh-CN,zh;q=0.9',
        'Origin': NEW_API.webUrl,
        'Referer': `${NEW_API.webUrl}/`,
        'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Mobile Safari/537.36'
      },
      timeout: 30000
    });

    // è¯¥æ¥å£å¯èƒ½è¿”å›åŠ å¯†/å‹ç¼©åçš„å­—ç¬¦ä¸²ï¼ˆéJSONï¼‰ï¼Œæ­¤å¤„å…ˆé€ä¼ 
    const raw = response.data;
    console.log('[é€‰æ‹©é“¶è¡Œæ¸ é“-2] åŸå§‹å“åº”ç±»å‹:', typeof raw);
    if (typeof raw === 'string') {
      const responseData = { success: true, cipher: raw };
      logApiResponse('é€‰æ‹©é“¶è¡Œæ¸ é“(305897)-é€ä¼ ', responseData);
      return res.json(responseData);
    }

    // è‹¥è¿”å›ä¸ºJSONï¼Œåˆ™ç›´æ¥è¿”å›
    const responseData = { success: true, data: raw };
    logApiResponse('é€‰æ‹©é“¶è¡Œæ¸ é“(305897)-JSON', responseData);
    res.json(responseData);

  } catch (error) {
    console.error('âŒ é€‰æ‹©é“¶è¡Œæ¸ é“(æ–¹æ¡ˆäºŒ)å¤±è´¥:', error.message);
    if (error.response) {
      return res.status(200).json({
        success: false,
        message: 'é€‰æ‹©é“¶è¡Œæ¸ é“å¤±è´¥',
        data: error.response.data
      });
    }
    res.status(500).json({
      success: false,
      message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•',
      error: error.message
    });
  }
});

// æäº¤ç»‘å¡æ¥å£
// æ¥å£åœ°å€: POST http://1.95.91.139:8088/api/uc_92300/306663
app.post('/api/submit-bind-card', async (req, res) => {
  try {
    const {
      bank_account,
      bank_no,
      channel_bank_no,
      mobile,
      client_name,
      fund_account,
      id_no,
      sms_code,
      session_id,
      user_id,
      // å¯é€‰å­—æ®µ
      is_flat = false,
      mode = 'BE',
      bind_status = '1',
      bank_account_type = '1',
      id_kind = 'P01',
      bank_pro_code = 'ljyClearing',
      exchange_id = 0,
      cust_type = 'mchtType02',
      bank_branch = '',
      bank_id = '',
      process_type = '1',
      curr_ip = '192.168.186.17'
    } = req.body;

    console.log('\n========== æäº¤ç»‘å¡ ==========');
    console.log('é“¶è¡Œå¡å·:', bank_account);
    console.log('é“¶è¡Œç¼–å·:', bank_no);
    console.log('æ‰‹æœºå·:', mobile);
    console.log('å§“å:', client_name);
    console.log('èµ„é‡‘è´¦å·:', fund_account);

    // Validate required fields
    if (!bank_account || !bank_no || !mobile || !client_name || !fund_account || !id_no || !sms_code) {
      return res.json({
        success: false,
        message: 'è¯·æä¾›å®Œæ•´çš„ç»‘å¡ä¿¡æ¯'
      });
    }

    const apiUrl = 'http://1.95.91.139:8088/api/uc_92300/306663';

    const requestData = {
      is_flat,
      mode,
      bind_status,
      bank_account,
      bank_account_type,
      id_kind,
      id_no,
      bank_no,
      bank_pro_code,
      channel_bank_no: channel_bank_no || bank_no,
      exchange_id,
      mobile,
      client_name,
      fund_account,
      cust_type,
      session_id: session_id || '',
      user_id: user_id || '',
      bank_branch,
      bank_id,
      sms_code,
      process_type,
      curr_ip
      // ä¸éœ€è¦ trans_codeï¼ˆæ ¹æ®çœŸå® API è°ƒç”¨ï¼‰
    };

    console.log('[æäº¤ç»‘å¡] è¯·æ±‚å‚æ•°:', requestData);

    const response = await axios.post(apiUrl, requestData, {
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      timeout: 15000
    });

    console.log('[æäº¤ç»‘å¡] å“åº”:', response.data);
    logApiResponse('æäº¤ç»‘å¡(306663)', response.data);

    // Check enum_fund_code for success
    if (response.data && response.data.data && response.data.data.length > 0) {
      const result = response.data.data[0];

      if (result.enum_fund_code === '0000') {
        res.json({
          success: true,
          message: result.enum_fund_desc || 'ç»‘å¡æˆåŠŸ',
          data: result
        });
      } else {
        res.json({
          success: false,
          message: result.enum_fund_desc || 'ç»‘å¡å¤±è´¥',
          data: result
        });
      }
    } else {
      res.json({
        success: false,
        message: 'ç»‘å¡å¤±è´¥',
        data: response.data
      });
    }

  } catch (error) {
    console.error('âŒ æäº¤ç»‘å¡å¤±è´¥:', error.message);
    res.status(500).json({
      success: false,
      message: 'ç»‘å¡å¤±è´¥',
      error: error.message
    });
  }
});

// é“¶è¡Œå¡ç»‘å®šæ¥å£ï¼ˆæœ€ç»ˆç»‘å®šï¼‰
// æ¥å£åœ°å€: POST http://1.95.91.139:9200/306426
// ç”¨é€”: ä½¿ç”¨ç»‘å¡éªŒè¯ç å®Œæˆæœ€ç»ˆçš„é“¶è¡Œå¡ç»‘å®š
app.post('/api/bind-bank-card-final', async (req, res) => {
  try {
    const {
      isFlat = false,
      mode = "BE",
      bind_status = "1",
      bank_account,
      bank_account_type = "1",
      id_kind = "P01",
      id_no,
      bank_no = "1001",
      bank_pro_code = "ljyClearing",
      channel_bank_no,
      exchange_id = 0,
      mobile,
      client_name,
      fund_account,
      cust_type = "mchtType02",
      session_id,
      user_id,
      bank_branch = "",
      bank_id = "ljyClearing",
      sms_code,
      process_type = "2",
      id,
      bank_name,
      sessionId,
      token,
      app_id = 'qoRz2jvwG0HmaEfxr7lV'
    } = req.body;

    console.log('\n========== é“¶è¡Œå¡ç»‘å®š (306426) ==========');
    console.log('é“¶è¡Œå¡å·:', bank_account);
    console.log('é“¶è¡Œåç§°:', bank_name);
    console.log('è®¤è¯ID:', id);
    console.log('èµ„é‡‘è´¦å·:', fund_account);

    // Validate required fields
    if (!bank_account || !mobile || !client_name || !fund_account || !id_no || !sms_code || !id) {
      return res.json({
        success: false,
        message: 'è¯·æä¾›å®Œæ•´çš„ç»‘å¡ä¿¡æ¯'
      });
    }

    const apiUrl = 'http://1.95.91.139:9200/306426';

    const requestData = {
      isFlat,
      mode,
      bind_status,
      bank_account,
      bank_account_type,
      id_kind,
      id_no,
      bank_no,
      bank_pro_code,
      channel_bank_no,
      exchange_id,
      mobile,
      client_name,
      fund_account,
      cust_type,
      session_id,
      user_id,
      bank_branch,
      bank_id,
      sms_code,
      process_type,
      id,
      bank_name,
      sessionId,
      token,
      app_id
    };

    console.log('è¯·æ±‚å‚æ•°:', JSON.stringify(requestData, null, 2));

    const response = await axios.post(apiUrl, requestData, {
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      timeout: 15000
    });

    console.log('[é“¶è¡Œå¡ç»‘å®š] å“åº”:', response.data);
    logApiResponse('é“¶è¡Œå¡ç»‘å®š(306426)', response.data);

    // Check enum_fund_code for success
    if (response.data && response.data.data && response.data.data.length > 0) {
      const result = response.data.data[0];

      if (result.enum_fund_code === '0000') {
        res.json({
          success: true,
          message: result.enum_fund_desc || 'é“¶è¡Œå¡ç»‘å®šæˆåŠŸ',
          data: result
        });
      } else {
        res.json({
          success: false,
          message: result.enum_fund_message || result.enum_fund_desc || 'é“¶è¡Œå¡ç»‘å®šå¤±è´¥',
          code: result.enum_fund_code
        });
      }
    } else {
      res.json({
        success: false,
        message: 'é“¶è¡Œå¡ç»‘å®šå¤±è´¥ï¼šè¿”å›æ•°æ®æ ¼å¼é”™è¯¯'
      });
    }

  } catch (error) {
    console.error('é“¶è¡Œå¡ç»‘å®šå¤±è´¥:', error.message);
    if (error.response) {
      console.error('å“åº”çŠ¶æ€:', error.response.status);
      console.error('å“åº”æ•°æ®:', error.response.data);
    }
    res.status(500).json({
      success: false,
      message: 'é“¶è¡Œå¡ç»‘å®šå¤±è´¥',
      error: error.message
    });
  }
});

// æŸ¥è¯¢é“¶è¡Œå¡ä¿¡æ¯æ¥å£
// æ¥å£åœ°å€: POST http://1.95.91.139:8088/api/uc_92300/306228
// ç”¨é€”: åœ¨é“¶è¡Œå¡è®¤è¯å®Œæˆåè°ƒç”¨ï¼Œè·å–è®¤è¯åçš„é“¶è¡Œå¡ä¿¡æ¯ï¼ˆåŒ…æ‹¬idï¼‰
app.post('/api/query-bank-card-info', async (req, res) => {
  try {
    const {
      is_flat = false,
      exchange_id = "0",
      user_id,
      root_user_id,
      is_admin = true,
      curr_ip = "192.168.186.17"
    } = req.body;

    console.log('\n========== æŸ¥è¯¢é“¶è¡Œå¡ä¿¡æ¯ (306228) ==========');
    console.log('ç”¨æˆ·ID:', user_id);
    console.log('æ ¹ç”¨æˆ·ID:', root_user_id);

    if (!user_id || !root_user_id) {
      return res.json({
        success: false,
        message: 'è¯·æä¾›ç”¨æˆ·ID'
      });
    }

    const apiUrl = 'http://1.95.91.139:8088/api/uc_92300/306228';

    const requestData = {
      is_flat,
      exchange_id,
      user_id,
      root_user_id,
      is_admin,
      curr_ip
    };

    console.log('è¯·æ±‚å‚æ•°:', JSON.stringify(requestData, null, 2));

    const response = await axios.post(apiUrl, requestData, {
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      timeout: 15000
    });

    console.log('[æŸ¥è¯¢é“¶è¡Œå¡ä¿¡æ¯] å“åº”:', response.data);
    logApiResponse('æŸ¥è¯¢é“¶è¡Œå¡ä¿¡æ¯(306228)', response.data);

    // ç›´æ¥è¿”å›åŸå§‹æ•°æ®
    res.json({
      success: true,
      message: 'æŸ¥è¯¢æˆåŠŸ',
      data: response.data.data || []
    });

  } catch (error) {
    console.error('æŸ¥è¯¢é“¶è¡Œå¡ä¿¡æ¯å¤±è´¥:', error.message);
    if (error.response) {
      console.error('å“åº”çŠ¶æ€:', error.response.status);
      console.error('å“åº”æ•°æ®:', error.response.data);
    }
    res.status(500).json({
      success: false,
      message: 'æŸ¥è¯¢é“¶è¡Œå¡ä¿¡æ¯å¤±è´¥',
      error: error.message
    });
  }
});

// 7. å›¾ç‰‡ä¸Šä¼ æ¥å£ï¼ˆé¢„ç•™ï¼Œå¾…éªŒè¯ï¼‰
// ç”¨é€”ï¼šä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ï¼ˆå°†å›¾ç‰‡è½¬æ¢ä¸ºBase64å­—ç¬¦ä¸²åä¸Šä¼ ï¼‰
// æ¥å£åœ°å€ï¼šPOST http://1.95.91.139:9200/307453
app.post('/api/upload-image', async (req, res) => {
  try {
    const {
      file_name,
      base64_string,
      app_id = 'qoRz2jvwG0HmaEfxr7lV'
    } = req.body;

    console.log('\n========== å›¾ç‰‡ä¸Šä¼  ==========');
    console.log('æ–‡ä»¶å:', file_name);
    console.log('Base64é•¿åº¦:', base64_string ? base64_string.length : 0);

    // æ•°æ®æ ¡éªŒ
    if (!file_name || !base64_string) {
      return res.json({
        success: false,
        message: 'è¯·æä¾›æ–‡ä»¶åå’Œå›¾ç‰‡æ•°æ®'
      });
    }

    const apiUrl = `${NEW_API.baseUrl}/307453`;
    
    const requestData = {
      file_name: file_name,
      base64_string: base64_string,
      app_id: app_id
    };

    console.log('[å›¾ç‰‡ä¸Šä¼ ] å‘é€è¯·æ±‚åˆ°:', apiUrl);
    console.log('[å›¾ç‰‡ä¸Šä¼ ] æ–‡ä»¶å:', file_name);
    console.log('[å›¾ç‰‡ä¸Šä¼ ] App ID:', app_id);

    const response = await axios.post(apiUrl, requestData, {
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'Accept-Encoding': 'gzip, deflate',
        'Accept-Language': 'zh-CN,zh;q=0.9',
        'Origin': NEW_API.webUrl,
        'Referer': `${NEW_API.webUrl}/`,
        'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Mobile Safari/537.36'
      },
      timeout: 30000  // å›¾ç‰‡ä¸Šä¼ å¯èƒ½è¾ƒæ…¢ï¼Œè®¾ç½®30ç§’è¶…æ—¶
    });

    console.log('[å›¾ç‰‡ä¸Šä¼ ] å“åº”:', response.data);

    // è¿”å›ç»“æœ
    // data[0].is_success: "1" è¡¨ç¤ºä¸Šä¼ æˆåŠŸ
    // data[0].file_id: æ–‡ä»¶IDï¼ˆç”¨äºåç»­ç»‘å®šï¼‰
    // data[0].file_path: æ–‡ä»¶è·¯å¾„
    // data[0].suffix: æ–‡ä»¶åç¼€
    if (response.data && response.data.data && response.data.data[0]) {
      const uploadResult = response.data.data[0];
      
      if (uploadResult.is_success === "1") {
        res.json({
          success: true,
          message: 'å›¾ç‰‡ä¸Šä¼ æˆåŠŸ',
          data: {
            file_id: uploadResult.file_id,
            file_path: uploadResult.file_path,
            suffix: uploadResult.suffix
          }
        });
      } else {
        res.json({
          success: false,
          message: 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥',
          data: uploadResult
        });
      }
    } else {
      res.json({
        success: false,
        message: 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥',
        data: response.data
      });
    }

  } catch (error) {
    console.error('[å›¾ç‰‡ä¸Šä¼ ] è¯·æ±‚å¤±è´¥:', error.message);
    
    if (error.response) {
      res.status(200).json({
        success: false,
        message: 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥',
        data: error.response.data
      });
    } else {
      res.status(500).json({
        success: false,
        message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•',
        error: error.message
      });
    }
  }
});

// 8. è·å–é“¶è¡Œåˆ—è¡¨æ¥å£ï¼ˆå¾…éªŒè¯ï¼‰
// ç”¨é€”ï¼šè·å–æ‰€æœ‰æ”¯æŒçš„é“¶è¡Œåˆ—è¡¨
// æ¥å£åœ°å€ï¼šPOST http://1.95.91.139:9200/314626
app.post('/api/get-bank-list', async (req, res) => {
  try {
    const {
      userId,  // å¿…é¡»ç”±å‰ç«¯æä¾›
      exchangeId = 0,
      bank_pro_code = 'ljyClearing',
      sessionId,
      token,
      app_id = 'qoRz2jvwG0HmaEfxr7lV',
      isFlat = false
    } = req.body;

    console.log('\n========== è·å–é“¶è¡Œåˆ—è¡¨ ==========');
    console.log('ç”¨æˆ·ID:', userId);
    console.log('SessionId:', sessionId);

    // æ•°æ®æ ¡éªŒ
    if (!userId) {
      return res.json({
        success: false,
        message: 'è¯·æä¾›ç”¨æˆ·ID'
      });
    }

    const apiUrl = 'http://1.95.91.139:9200/314626';
    const requestData = {
      isFlat,
      userId,
      exchangeId,
      bank_pro_code,
      sessionId,
      token,
      app_id
    };

    console.log('è¯·æ±‚URL:', apiUrl);
    console.log('è¯·æ±‚æ•°æ®:', JSON.stringify(requestData, null, 2));

    const response = await axios.post(apiUrl, requestData, {
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      timeout: 30000
    });

    console.log('å“åº”çŠ¶æ€:', response.status);
    console.log('å“åº”æ•°æ®:', JSON.stringify(response.data, null, 2));

    res.json({
      success: true,
      data: response.data
    });

  } catch (error) {
    console.error('[è·å–é“¶è¡Œåˆ—è¡¨] è¯·æ±‚å¤±è´¥:', error.message);

    if (error.response) {
      console.error('é”™è¯¯å“åº”:', error.response.data);
      res.status(200).json({
        success: false,
        message: 'è·å–é“¶è¡Œåˆ—è¡¨å¤±è´¥',
        data: error.response.data
      });
    } else {
      res.status(500).json({
        success: false,
        message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•',
        error: error.message
      });
    }
  }
});

// 9. ç»‘å®šå›¾ç‰‡æ¥å£ï¼ˆé¢„ç•™ï¼Œå¾…éªŒè¯ï¼‰
// ç”¨é€”ï¼šå°†ä¸Šä¼ çš„å›¾ç‰‡ç»‘å®šåˆ°æŒ‡å®šç±»å‹ï¼ˆé€šè¿‡card_typeåŒºåˆ†ä¸åŒå›¾ç‰‡ï¼‰
// æ¥å£åœ°å€ï¼šPOST http://1.95.91.139:9200/314470
// è¯´æ˜ï¼šéœ€è¦å…ˆè°ƒç”¨å›¾ç‰‡ä¸Šä¼ æ¥å£è·å–file_idï¼Œç„¶åè°ƒç”¨æ­¤æ¥å£è¿›è¡Œç»‘å®š
app.post('/api/bind-image', async (req, res) => {
  try {
    const {
      file_id,
      card_type,
      isFlat = false,
      app_id = 'qoRz2jvwG0HmaEfxr7lV'
    } = req.body;

    console.log('\n========== ç»‘å®šå›¾ç‰‡ ==========');
    console.log('æ–‡ä»¶ID:', file_id);
    console.log('å¡ç‰‡ç±»å‹:', card_type);

    // æ•°æ®æ ¡éªŒ
    if (!file_id || !card_type) {
      return res.json({
        success: false,
        message: 'è¯·æä¾›æ–‡ä»¶IDå’Œå¡ç‰‡ç±»å‹'
      });
    }

    const apiUrl = `${NEW_API.baseUrl}/314470`;
    
    const requestData = {
      isFlat: isFlat,
      card_type: card_type,
      file_id: file_id,
      app_id: app_id
    };

    console.log('[ç»‘å®šå›¾ç‰‡] å‘é€è¯·æ±‚åˆ°:', apiUrl);
    console.log('[ç»‘å®šå›¾ç‰‡] è¯·æ±‚æ•°æ®:', requestData);

    const response = await axios.post(apiUrl, requestData, {
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'Accept-Encoding': 'gzip, deflate',
        'Accept-Language': 'zh-CN,zh;q=0.9',
        'Origin': NEW_API.webUrl,
        'Referer': `${NEW_API.webUrl}/`,
        'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Mobile Safari/537.36'
      },
      timeout: 10000
    });

    console.log('[ç»‘å®šå›¾ç‰‡] å“åº”:', response.data);

    // è¿”å›ç»“æœ
    // data[0].result: "{}" è¡¨ç¤ºç»‘å®šæˆåŠŸ
    if (response.data && response.data.data && response.data.data[0]) {
      res.json({
        success: true,
        message: 'å›¾ç‰‡ç»‘å®šæˆåŠŸ',
        data: response.data.data[0]
      });
    } else {
      res.json({
        success: false,
        message: 'å›¾ç‰‡ç»‘å®šå¤±è´¥',
        data: response.data
      });
    }

  } catch (error) {
    console.error('[ç»‘å®šå›¾ç‰‡] è¯·æ±‚å¤±è´¥:', error.message);
    
    if (error.response) {
      res.status(200).json({
        success: false,
        message: 'å›¾ç‰‡ç»‘å®šå¤±è´¥',
        data: error.response.data
      });
    } else {
      res.status(500).json({
        success: false,
        message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•',
        error: error.message
      });
    }
  }
});

// 9. å›¾ç‰‡ä¸Šä¼ +ç»‘å®šä¸€ä½“åŒ–æ¥å£ï¼ˆé¢„ç•™ï¼Œå¾…éªŒè¯ï¼‰
// ç”¨é€”ï¼šç®€åŒ–æµç¨‹ï¼Œä¸€æ¬¡æ€§å®Œæˆå›¾ç‰‡ä¸Šä¼ å’Œç»‘å®š
// è¯´æ˜ï¼šå…ˆä¸Šä¼ å›¾ç‰‡è·å–file_idï¼Œå†è‡ªåŠ¨ç»‘å®šåˆ°æŒ‡å®šcard_type
app.post('/api/upload-and-bind-image', async (req, res) => {
  try {
    const {
      file_name,
      base64_string,
      card_type,
      app_id = 'qoRz2jvwG0HmaEfxr7lV'
    } = req.body;

    console.log('\n========== å›¾ç‰‡ä¸Šä¼ +ç»‘å®š ==========');
    console.log('æ–‡ä»¶å:', file_name);
    console.log('å¡ç‰‡ç±»å‹:', card_type);

    // æ•°æ®æ ¡éªŒ
    if (!file_name || !base64_string || !card_type) {
      return res.json({
        success: false,
        message: 'è¯·æä¾›æ–‡ä»¶åã€å›¾ç‰‡æ•°æ®å’Œå¡ç‰‡ç±»å‹'
      });
    }

    // ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡
    console.log('[ä¸€ä½“åŒ–] æ­¥éª¤1ï¼šä¸Šä¼ å›¾ç‰‡');
    const uploadUrl = `${NEW_API.baseUrl}/307453`;
    const uploadData = {
      file_name: file_name,
      base64_string: base64_string,
      app_id: app_id
    };

    const uploadResponse = await axios.post(uploadUrl, uploadData, {
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'Accept-Encoding': 'gzip, deflate',
        'Accept-Language': 'zh-CN,zh;q=0.9',
        'Origin': NEW_API.webUrl,
        'Referer': `${NEW_API.webUrl}/`,
        'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Mobile Safari/537.36'
      },
      timeout: 30000
    });

    console.log('[ä¸€ä½“åŒ–] ä¸Šä¼ å“åº”:', uploadResponse.data);
    console.log('[ä¸€ä½“åŒ–] ä¸Šä¼ å“åº”å®Œæ•´ç»“æ„:', JSON.stringify(uploadResponse.data, null, 2));

    if (!uploadResponse.data || !uploadResponse.data.data || !uploadResponse.data.data[0]) {
      return res.json({
        success: false,
        message: 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥',
        data: uploadResponse.data
      });
    }

    const uploadResult = uploadResponse.data.data[0];
    if (uploadResult.is_success !== "1") {
      return res.json({
        success: false,
        message: 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥',
        data: uploadResult
      });
    }

    const file_id = uploadResult.file_id;
    console.log('[ä¸€ä½“åŒ–] è·å–åˆ°æ–‡ä»¶ID:', file_id);

    // ç¬¬äºŒæ­¥ï¼šç»‘å®šå›¾ç‰‡
    console.log('[ä¸€ä½“åŒ–] æ­¥éª¤2ï¼šç»‘å®šå›¾ç‰‡');
    const bindUrl = `${NEW_API.baseUrl}/314470`;
    const bindData = {
      isFlat: false,
      card_type: card_type,
      file_id: file_id,
      app_id: app_id
    };

    const bindResponse = await axios.post(bindUrl, bindData, {
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'Accept-Encoding': 'gzip, deflate',
        'Accept-Language': 'zh-CN,zh;q=0.9',
        'Origin': NEW_API.webUrl,
        'Referer': `${NEW_API.webUrl}/`,
        'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Mobile Safari/537.36'
      },
      timeout: 10000
    });

    console.log('[ä¸€ä½“åŒ–] ç»‘å®šå“åº”:', bindResponse.data);
    console.log('[ä¸€ä½“åŒ–] ç»‘å®šå“åº”å®Œæ•´ç»“æ„:', JSON.stringify(bindResponse.data, null, 2));

    // è¿”å›å®Œæ•´ç»“æœï¼ˆåŒ…å«ä¸Šä¼ å’Œç»‘å®šçš„æ‰€æœ‰æ•°æ®ï¼‰
    res.json({
      success: true,
      message: 'å›¾ç‰‡ä¸Šä¼ å¹¶ç»‘å®šæˆåŠŸ',
      data: {
        file_id: file_id,
        file_path: uploadResult.file_path,
        suffix: uploadResult.suffix,
        card_type: card_type,
        upload_result: uploadResult,  // æ·»åŠ ä¸Šä¼ æ¥å£çš„å®Œæ•´è¿”å›ï¼ˆå¯èƒ½åŒ…å«OCRæ•°æ®ï¼‰
        bind_result: bindResponse.data
      }
    });

  } catch (error) {
    console.error('[ä¸€ä½“åŒ–] è¯·æ±‚å¤±è´¥:', error.message);
    
    if (error.response) {
      res.status(200).json({
        success: false,
        message: 'æ“ä½œå¤±è´¥',
        data: error.response.data
      });
    } else {
      res.status(500).json({
        success: false,
        message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•',
        error: error.message
      });
    }
  }
});

// APIç«¯ç‚¹ - è·å–é“¶è¡Œåˆ—è¡¨
app.get('/api/bank-list', (req, res) => {
  res.json({
    success: true,
    banklist: BANK_LIST
  });
});

// æ³¨æ„:ç»‘å¡åŠŸèƒ½å·²åºŸå¼ƒ,æ”¹ä¸ºä½¿ç”¨ç‹¬ç«‹çš„ç»‘å¡æ¥å£ /api/bind-card

// APIä»£ç†ç«¯ç‚¹ - ç”¨æˆ·ç™»å½•
app.post('/api/login', async (req, res) => {
  try {
    const { tel, pwd, logintype } = req.body;

    // æ„å»ºè¯·æ±‚å‚æ•°
    const apiUrl = `${EXCHANGE_API.baseUrl}?s=/ApiIndex/loginsub&aid=${EXCHANGE_API.params.aid}&platform=${EXCHANGE_API.params.platform}&session_id=${EXCHANGE_API.params.session_id}&pid=${EXCHANGE_API.params.pid}&scene=${EXCHANGE_API.params.scene}`;

    // å‡†å¤‡è¯·æ±‚æ•°æ®
    const requestData = {
      tel: tel || '13116005610',     // é»˜è®¤ä½¿ç”¨å›ºå®šæ‰‹æœºå·
      pwd: pwd || 'aa112233',         // é»˜è®¤ä½¿ç”¨å›ºå®šå¯†ç 
      logintype: logintype || 1,     // ç™»å½•ç±»å‹ï¼Œé»˜è®¤ä¸º1
      pid: 0
    };

    console.log('å‘é€ç™»å½•è¯·æ±‚åˆ°äº¤æ˜“æ‰€:', apiUrl);
    console.log('è¯·æ±‚æ•°æ®:', requestData);

    // è°ƒç”¨äº¤æ˜“æ‰€æ¥å£
    const response = await axios.post(apiUrl, requestData, {
      headers: {
        'Content-Type': 'application/json',
        'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:144.0) Gecko/20100101 Firefox/144.0',
        'Accept': '*/*',
        'Accept-Language': 'zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2',
        'Origin': 'https://qcmpce.gzcj-szh.com',
        'Referer': 'https://qcmpce.gzcj-szh.com/h5/5.html',
        'Cookie': `PHPSESSID=${EXCHANGE_API.params.session_id}`
      },
      timeout: 10000
    });

    console.log('äº¤æ˜“æ‰€ç™»å½•å“åº”:', response.data);

    // è¿”å›ç»“æœç»™å‰ç«¯
    res.json({
      success: response.data.status === 1,
      data: response.data,
      message: response.data.msg || 'ç™»å½•æˆåŠŸ',
      // è¿”å›é‡è¦ä¿¡æ¯
      mid: response.data.mid,
      session_id: response.data.session_id,
      socket_token: response.data.socket_token
    });

  } catch (error) {
    console.error('ç™»å½•è¯·æ±‚å¤±è´¥:', error.message);
    
    // é”™è¯¯å¤„ç†
    if (error.response) {
      // äº¤æ˜“æ‰€è¿”å›çš„é”™è¯¯
      res.status(200).json({
        success: false,
        data: error.response.data,
        message: error.response.data.msg || 'ç™»å½•å¤±è´¥'
      });
    } else {
      // ç½‘ç»œæˆ–å…¶ä»–é”™è¯¯
      res.status(500).json({
        success: false,
        message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•',
        error: error.message
      });
    }
  }
});

// æäº¤å®åè®¤è¯æ¥å£ - ç”¨æˆ·ç‚¹å‡»æäº¤æ—¶è°ƒç”¨
app.post('/api/submit-realname', async (req, res) => {
  try {
    const { realName, idCard, frontImage, backImage, sessionId } = req.body;

    console.log('\n========== æäº¤å®åè®¤è¯ ==========');
    console.log('å§“å:', realName);
    console.log('èº«ä»½è¯:', idCard);
    console.log('æ­£é¢å›¾ç‰‡URL:', frontImage);
    console.log('åé¢å›¾ç‰‡URL:', backImage);
    console.log('SessionID:', sessionId || EXCHANGE_API.params.session_id);

    // éªŒè¯å¿…è¦å‚æ•°
    if (!realName || !idCard || !frontImage || !backImage) {
      return res.json({
        success: false,
        message: 'ç¼ºå°‘å¿…è¦å‚æ•°'
      });
    }

    // è°ƒç”¨äº¤æ˜“æ‰€å®åè®¤è¯æ¥å£
    const authUrl = `${EXCHANGE_API.baseUrl}?s=/ApiMy/authuser&aid=${EXCHANGE_API.params.aid}&platform=${EXCHANGE_API.params.platform}&session_id=${sessionId || EXCHANGE_API.params.session_id}&pid=${EXCHANGE_API.params.pid}&scene=${EXCHANGE_API.params.scene}`;
    
    const authData = {
      type: 1,
      usercard: idCard,
      realname: realName,
      front_image: frontImage,
      back_image: backImage,
      hand_image: '',
      trade_image: ''
    };

    console.log('[æäº¤å®å] å‘é€è¯·æ±‚åˆ°äº¤æ˜“æ‰€:', authUrl);
    console.log('[æäº¤å®å] è¯·æ±‚æ•°æ®:', {
      type: authData.type,
      usercard: authData.usercard,
      realname: authData.realname,
      front_image: 'å·²æä¾›',
      back_image: 'å·²æä¾›'
    });

    try {
      const response = await axios.post(authUrl, authData, {
        headers: {
          'Content-Type': 'application/json',
          'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:144.0) Gecko/20100101 Firefox/144.0',
          'Accept': '*/*',
          'Accept-Language': 'zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2',
          'Origin': 'https://qcmpce.gzcj-szh.com',
          'Referer': 'https://qcmpce.gzcj-szh.com/h5/5.html',
          'Cookie': `PHPSESSID=${sessionId || EXCHANGE_API.params.session_id}`
        },
        timeout: 30000
      });

      console.log('[æäº¤å®å] äº¤æ˜“æ‰€å“åº”:', JSON.stringify(response.data, null, 2));

      // æ ¹æ®çœŸå®æ¥å£è¿”å›æ ¼å¼å¤„ç†
      if (response.data) {
        const { status, msg } = response.data;
        
        if (status === 1) {
          // å®åæˆåŠŸ
          console.log('[æäº¤å®å] âœ… è®¤è¯æˆåŠŸ');
          res.json({
            success: true,
            message: msg || 'å®åè®¤è¯æˆåŠŸ',
            data: {
              realName,
              idCard,
              verified: true
            }
          });
        } else if (status === 0) {
          // å®åå¤±è´¥ï¼ˆå¦‚ï¼šèº«ä»½è¯å·æ ¼å¼é”™è¯¯ï¼‰
          console.log('[æäº¤å®å] âŒ è®¤è¯å¤±è´¥:', msg);
          res.json({
            success: false,
            message: msg || 'å®åè®¤è¯å¤±è´¥',
            data: response.data
          });
        } else if (msg && msg.includes('å·²ç»å®å')) {
          // ç”¨æˆ·å·²ç»å®åè®¤è¯è¿‡äº† - é™é»˜å¤„ç†ï¼Œè¿”å›æˆåŠŸ
          console.log('[æäº¤å®å] â„¹ï¸ ç”¨æˆ·å·²å®åï¼Œé™é»˜å¤„ç†');
          res.json({
            success: true,
            message: 'å®åè®¤è¯å·²å®Œæˆ',
            alreadyVerified: true,
            data: {
              realName,
              idCard,
              verified: true
            }
          });
        } else {
          // å…¶ä»–æƒ…å†µ
          res.json({
            success: true,
            message: msg || 'å®åè®¤è¯å·²æäº¤',
            data: {
              realName,
              idCard,
              verified: false
            }
          });
        }
      } else {
        // æ— å“åº”æ•°æ®
        res.json({
          success: false,
          message: 'æœåŠ¡å™¨å“åº”å¼‚å¸¸',
          data: null
        });
      }
    } catch (apiError) {
      console.error('[æäº¤å®å] äº¤æ˜“æ‰€æ¥å£è°ƒç”¨å¤±è´¥:', apiError.message);
      if (apiError.response) {
        console.error('[æäº¤å®å] å“åº”çŠ¶æ€:', apiError.response.status);
        console.error('[æäº¤å®å] å“åº”æ•°æ®:', apiError.response.data);
        
        // å¦‚æœæ˜¯äº¤æ˜“æ‰€è¿”å›çš„é”™è¯¯ï¼Œè§£æå¹¶è¿”å›
        if (apiError.response.data) {
          const { status, msg } = apiError.response.data;
          return res.json({
            success: status === 1,
            message: msg || 'å®åè®¤è¯å¤±è´¥',
            data: apiError.response.data
          });
        }
      }
      
      // ç½‘ç»œæˆ–å…¶ä»–é”™è¯¯
      res.json({
        success: false,
        message: 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•',
        error: apiError.message
      });
    }

  } catch (error) {
    console.error('[æäº¤å®å] è¯·æ±‚å¤±è´¥:', error.message);
    res.status(500).json({
      success: false,
      message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•',
      error: error.message
    });
  }
});

// ç‹¬ç«‹ç»‘å¡æ¥å£ - ä¾›å‰ç«¯å®åè®¤è¯åè°ƒç”¨
app.post('/api/bind-card', async (req, res) => {
  try {
    const { bankCard, bankName, realName, phone, sessionId } = req.body;

    console.log('\n========== ç»‘å¡è¯·æ±‚ ==========');
    console.log('é“¶è¡Œå¡å·:', bankCard);
    console.log('é“¶è¡Œåç§°:', bankName);
    console.log('æŒå¡äººå§“å:', realName);
    console.log('æ‰‹æœºå·:', phone);
    console.log('SessionID:', sessionId || EXCHANGE_API.params.session_id);

    // è°ƒç”¨äº¤æ˜“æ‰€ç»‘å¡æ¥å£
    // æ¥å£: /?s=/ApiMy/customer_bind
    const bindUrl = `${EXCHANGE_API.baseUrl}?s=/ApiMy/customer_bind&aid=${EXCHANGE_API.params.aid}&platform=${EXCHANGE_API.params.platform}&session_id=${sessionId || EXCHANGE_API.params.session_id}&pid=${EXCHANGE_API.params.pid}&scene=${EXCHANGE_API.params.scene}`;
    
    // ç»‘å¡æ•°æ® - æ•´åˆæ­¥éª¤1å’Œæ­¥éª¤2çš„æ•°æ®
    const bindData = {
      bankname: bankName || 'æœªçŸ¥é“¶è¡Œ',              // é“¶è¡Œåç§°ï¼ˆä»ç¬¬1æ­¥è·å–ï¼‰
      bankaddress: '',                               // é“¶è¡Œåœ°å€ï¼ˆå¯é€‰ï¼‰
      bankcarduser: realName,                        // æŒå¡äººå§“åï¼ˆä»ç¬¬2æ­¥å®åè®¤è¯è·å–ï¼‰
      bankcardnum: bankCard.replace(/\s/g, ''),      // é“¶è¡Œå¡å·ï¼ˆä»ç¬¬1æ­¥è·å–ï¼Œå»é™¤ç©ºæ ¼ï¼‰
      mobile: phone,                                 // é“¶è¡Œç»‘å®šæ‰‹æœºå·ï¼ˆä»ç¬¬1æ­¥è·å–ï¼‰
      bankcode: getBankCode(bankName)                // é“¶è¡Œä»£ç ï¼ˆè‡ªåŠ¨æ˜ å°„ï¼‰
    };

    console.log('[ç»‘å¡] å‘é€åˆ°äº¤æ˜“æ‰€:', bindUrl);
    console.log('[ç»‘å¡] è¯·æ±‚æ•°æ®:', bindData);
    
    try {
      const response = await axios.post(bindUrl, bindData, {
        headers: {
          'Content-Type': 'application/json',
          'Cookie': `PHPSESSID=${sessionId || EXCHANGE_API.params.session_id}`
        }
      });

      console.log('[ç»‘å¡] äº¤æ˜“æ‰€å“åº”:', JSON.stringify(response.data, null, 2));

      // æ£€æŸ¥å“åº”
      if (response.data && (response.data.status === 0 || response.data.msg === 'æ“ä½œæˆåŠŸ')) {
        res.json({
          success: true,
          message: 'é“¶è¡Œå¡ç»‘å®šæˆåŠŸ',
          data: response.data
        });
      } else if (response.data && response.data.msg && response.data.msg.includes('å·²ç»‘å®š')) {
        // å·²ç»ç»‘å®šè¿‡
        res.json({
          success: true,
          message: 'é“¶è¡Œå¡å·²ç»‘å®š',
          data: response.data
        });
      } else if (response.data && response.data.msg) {
        res.json({
          success: false,
          message: response.data.msg || 'ç»‘å¡å¤±è´¥',
          data: response.data
        });
      } else {
        res.json({
          success: true,
          message: 'ç»‘å¡è¯·æ±‚å·²æäº¤',
          data: response.data
        });
      }
    } catch (apiError) {
      console.error('[ç»‘å¡] äº¤æ˜“æ‰€æ¥å£è°ƒç”¨å¤±è´¥:', apiError.message);
      if (apiError.response) {
        console.error('[ç»‘å¡] å“åº”æ•°æ®:', apiError.response.data);
      }
      
      // å³ä½¿å‡ºé”™ä¹Ÿè¿”å›æˆåŠŸ
      res.json({
        success: true,
        message: 'ç»‘å¡è¯·æ±‚å·²æäº¤',
        data: {}
      });
    }

  } catch (error) {
    console.error('ç»‘å¡è¯·æ±‚å¤±è´¥:', error.message);
    res.status(500).json({
      success: false,
      message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•',
      error: error.message
    });
  }
});

// é“¶è¡Œä»£ç æ˜ å°„å‡½æ•°
function getBankCode(bankName) {
  const bankCodes = {
    'ä¸­å›½å·¥å•†é“¶è¡Œ': 'ICBC',
    'ä¸­å›½å†œä¸šé“¶è¡Œ': 'ABC',
    'ä¸­å›½é“¶è¡Œ': 'BOC',
    'ä¸­å›½å»ºè®¾é“¶è¡Œ': 'CCB',
    'äº¤é€šé“¶è¡Œ': 'COMM',
    'æ‹›å•†é“¶è¡Œ': 'CMB',
    'ä¸­å›½é‚®æ”¿å‚¨è“„é“¶è¡Œ': 'PSBC',
    'ä¸­ä¿¡é“¶è¡Œ': 'CITIC',
    'ä¸­å›½å…‰å¤§é“¶è¡Œ': 'CEB',
    'ä¸­å›½æ°‘ç”Ÿé“¶è¡Œ': 'CMBC',
    'å¹³å®‰é“¶è¡Œ': 'PAB',
    'ä¸Šæµ·æµ¦ä¸œå‘å±•é“¶è¡Œ': 'SPDB',
    'å…´ä¸šé“¶è¡Œ': 'CIB',
    'åå¤é“¶è¡Œ': 'HXB',
    'å¹¿ä¸œå‘å±•é“¶è¡Œ': 'GDB',
    'åŒ—äº¬é“¶è¡Œ': 'BOB',
    'ä¸Šæµ·é“¶è¡Œ': 'BOS'
  };
  
  return bankCodes[bankName] || 'OTHER';
}

// è·å–å®¢æˆ·ç«¯IPåœ°å€
app.get('/api/get-client-ip', (req, res) => {
  // è·å–å®¢æˆ·ç«¯çœŸå®IP
  // ä¼˜å…ˆä» X-Forwarded-For è·å–ï¼ˆå¦‚æœæœ‰ä»£ç†ï¼‰
  const forwardedFor = req.headers['x-forwarded-for'];
  const realIp = req.headers['x-real-ip'];
  const remoteAddress = req.connection.remoteAddress || req.socket.remoteAddress;

  let clientIp;

  if (forwardedFor) {
    // X-Forwarded-For å¯èƒ½åŒ…å«å¤šä¸ªIPï¼Œå–ç¬¬ä¸€ä¸ª
    clientIp = forwardedFor.split(',')[0].trim();
  } else if (realIp) {
    clientIp = realIp;
  } else {
    clientIp = remoteAddress;
  }

  // å¤„ç†IPv6çš„æœ¬åœ°åœ°å€
  if (clientIp === '::1' || clientIp === '::ffff:127.0.0.1') {
    clientIp = '127.0.0.1';
  }

  // å»é™¤IPv6å‰ç¼€
  if (clientIp && clientIp.startsWith('::ffff:')) {
    clientIp = clientIp.substring(7);
  }

  console.log('å®¢æˆ·ç«¯IP:', clientIp);

  res.json({
    success: true,
    ip: clientIp
  });
});

// å¥åº·æ£€æŸ¥ç«¯ç‚¹
app.get('/api/health', (req, res) => {
  res.json({ status: 'ok', message: 'KYC Portal API is running' });
});

// å¯åŠ¨æœåŠ¡å™¨
app.listen(PORT, () => {
  console.log(`\n========================================`);
  console.log(`ğŸš€ KYC Portal æœåŠ¡å™¨å·²å¯åŠ¨`);
  console.log(`ğŸ“¡ è®¿é—®åœ°å€: http://localhost:${PORT}`);
  console.log(`========================================\n`);
});
